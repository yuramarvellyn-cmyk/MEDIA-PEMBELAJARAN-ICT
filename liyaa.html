<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Petualangan Fisika 2D</title>
    <!-- Load Firebase config FIRST -->
    <script src="firebase-config.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@300;400;600;900&display=swap" rel="stylesheet">
    <style>
        body {
            margin: 0;
            overflow: hidden;
            font-family: 'Fredoka', sans-serif;
            background-color: #22c55e; /* Warna rumput */
            user-select: none;
            -webkit-user-select: none;
            touch-action: none;
        }
        
        #game-canvas {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            z-index: 1;
            cursor: crosshair;
            background-color: #22c55e;
        }

        #ui-layer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            z-index: 10; pointer-events: none;
        }

        .pointer-events-auto { pointer-events: auto; }

        /* UI Panels Optimized for Landscape */
        .glass-panel {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(8px);
            border: 3px solid #000;
            box-shadow: 8px 8px 0px rgba(0,0,0,0.2);
            border-radius: 1rem;
            max-height: 90vh;
            overflow-y: auto; /* Allow scrolling globally */
        }

        /* Special style for Home Screen */
        #screen-home.glass-panel {
            background: rgba(255, 255, 255, 0.0);
            border: 3px solid #000;
            display: flex;
            flex-direction: column;
        }

        .btn-3d {
            transition: transform 0.1s;
            border: 2px solid #000;
            border-bottom: 6px solid #000;
            cursor: pointer;
        }
        .btn-3d:active {
            transform: translateY(4px);
            border-bottom: 2px solid #000;
        }

        .dpad-btn {
            width: 64px; height: 64px;
            background: rgba(255, 255, 255, 0.9);
            border-radius: 12px;
            display: flex; align-items: center; justify-content: center;
            font-size: 28px; border: 3px solid #000;
            box-shadow: 4px 4px 0px rgba(0,0,0,0.2);
            touch-action: manipulation;
            cursor: pointer;
        }
        .dpad-btn:active { background: #fbbf24; transform: translate(2px, 2px); box-shadow: 2px 2px 0px rgba(0,0,0,0.2); }

        .hidden { display: none !important; }
        
        @keyframes floatText {
            0% { transform: translateY(0) rotate(-10deg); opacity: 1; }
            100% { transform: translateY(-80px) rotate(10deg); opacity: 0; }
        }
        .oof-text {
            position: absolute;
            color: #ef4444;
            font-weight: 900;
            font-size: 5rem;
            text-shadow: 3px 3px 0px black;
            animation: floatText 1.2s forwards;
            pointer-events: none;
            z-index: 50;
            white-space: nowrap;
        }

        @keyframes titleBounce {
            0%, 100% { transform: translateY(0) rotate(-2deg); }
            50% { transform: translateY(-10px) rotate(2deg); }
        }
        .game-title {
            animation: titleBounce 3s infinite ease-in-out;
            -webkit-text-stroke: 2px black;
            text-shadow: 4px 4px 0px rgba(0,0,0,1);
        }
        
        /* Cloud Animation for Main Menu */
        @keyframes floatCloud {
            0% { transform: translateX(0px); }
            50% { transform: translateX(20px); }
            100% { transform: translateX(0px); }
        }
        .cloud-anim {
            animation: floatCloud 5s ease-in-out infinite;
        }

        /* Map Landscape - Robbery Bob Style */
        #map-board {
            background-color: #4ade80; /* Bright grass */
            border: 4px solid #000; 
            box-shadow: 8px 8px 0px rgba(0,0,0,0.1);
            position: relative; 
            width: 100%; 
            max-width: 640px; 
            height: 300px;
            border-radius: 1rem; 
            margin: 0 auto;
            overflow: hidden;
        }
        /* Decorative Map Elements (Houses, Trees) */
        .map-deco {
            position: absolute; pointer-events: none; z-index: 1;
        }

        .map-pin {
            /* UKURAN DIPERBESAR DARI 40px KE 56px AGAR MUDAH DISENTUH */
            position: absolute; width: 56px; height: 56px; 
            background-color: #fde047; border: 3px solid #000;
            border-radius: 50%; display: flex; align-items: center; justify-content: center;
            font-weight: 900; font-size: 1.25rem; /* Font lebih besar */
            color: #000; cursor: pointer; z-index: 10;
            transition: transform 0.2s, background-color 0.2s;
            box-shadow: 4px 4px 0px rgba(0,0,0,0.5); /* Shadow lebih tebal */
        }
        .map-pin:hover { transform: translate(-50%, -50%) scale(1.15); } /* Hover lebih nendang */
        
        /* ANIMASI BERDENYUT UNTUK LEVEL SAAT INI */
        @keyframes pinPulse {
            0% { box-shadow: 0 0 0 0 rgba(250, 204, 21, 0.7), 4px 4px 0px rgba(0,0,0,0.5); transform: scale(1); }
            70% { box-shadow: 0 0 0 15px rgba(250, 204, 21, 0), 4px 4px 0px rgba(0,0,0,0.5); transform: scale(1.1); }
            100% { box-shadow: 0 0 0 0 rgba(250, 204, 21, 0), 4px 4px 0px rgba(0,0,0,0.5); transform: scale(1); }
        }
        
        .map-pin.current {
            background-color: #ffffff; /* Putih agar kontras */
            border-color: #ca8a04;     /* Border emas gelap */
            color: #ca8a04;
            animation: pinPulse 2s infinite; /* Animasi aktif */
            z-index: 20; /* Selalu di atas */
        }

        .map-pin.locked { background-color: #9ca3af; color: #4b5563; cursor: not-allowed; transform: scale(0.9); }
        .map-pin.completed { background-color: #22c55e; color: white; border-color: #14532d; }
        .map-pin.finish { background-color: #f97316; }
        
        .map-pin-label {
            position: absolute; bottom: -22px; left: 50%; transform: translateX(-50%);
            font-size: 11px; font-weight: bold;
            background: white; padding: 2px 6px; border: 2px solid black; border-radius: 4px; white-space: nowrap;
            box-shadow: 2px 2px 0px rgba(0,0,0,0.2);
            z-index: 25;
        }
        
        .svg-icon { width: 100%; height: 100%; }

        /* Simulation Styles */
        .sim-stage {background:#fff;border:2px solid #ddd;border-radius:6px;padding:8px;display:flex;flex-direction:column;gap:8px;}
        .sim-canvas {background:#eef4fb;border:1px solid #cfdbea;border-radius:4px;width:100%;height:150px;}
        .sim-row {margin-bottom:4px; display:flex; align-items:center; gap: 8px; font-size: 11px;}
        .sim-row label {font-weight:bold; display:flex; align-items:center; gap:4px;}
        .sim-row input[type=range]{flex:1;}
        .sim-row input[type=number]{width:60px; padding:2px; border:1px solid #ccc; border-radius:3px;}
        .sim-btn {padding:4px 10px;border-radius:4px;border:1px solid #2b6cb0;background:#3182ce;color:white;cursor:pointer;font-size:11px;font-weight:bold;}
        .sim-btn.secondary {background:#e2e8f0;color:#111;border:1px solid #cbd5e1;}
        .sim-stats {background:#f8fafc;padding:6px;border-radius:4px;border:1px solid #e6eef7;font-size:10px;font-family:monospace;}
        .sim-flex {display:flex;gap:8px;align-items:center;}

        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb { background: #888; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #555; }
    </style>
</head>
<body>

    <canvas id="game-canvas"></canvas>
    <div id="effect-layer" class="absolute inset-0 pointer-events-none z-40 overflow-hidden"></div>

    <div id="ui-layer" class="flex flex-col justify-between p-2 md:p-4 h-full">
        
        <!-- HUD -->
        <div id="hud" class="flex justify-between w-full hidden items-start pointer-events-none z-30">
            <div class="glass-panel px-3 py-1 pointer-events-auto flex items-center gap-2 shadow-lg bg-white scale-90 origin-top-left">
                <div id="avatar-icon" class="w-10 h-10 bg-blue-100 rounded-lg p-0 border-2 border-black overflow-hidden flex items-center justify-center"></div>
                <div>
                    <div class="text-[10px] text-gray-500 font-black tracking-wider">KARAKTER</div>
                    <div id="player-name-display" class="font-black text-lg text-gray-800 leading-none">Noob</div>
                </div>
                <div class="border-l-2 border-black pl-2 ml-1">
                    <div class="text-[10px] text-gray-500 font-black tracking-wider">SKOR</div>
                    <div id="score-display" class="font-black text-lg text-gray-800 leading-none">0</div>
                </div>
            </div>
            
            <div class="glass-panel px-3 py-1 flex items-center text-black font-black shadow-lg mb-2 bg-yellow-300 pointer-events-auto scale-90 origin-top-right">
                <span class="mr-2 text-xs uppercase">Misi:</span>
                <span id="objective-text" class="bg-white px-2 py-0.5 rounded border-2 border-black text-xs">LEVEL 1</span>
            </div>
        </div>

        <!-- SCREENS -->
        <div class="absolute inset-0 flex items-center justify-center pointer-events-none z-20 p-4">
            
            <!-- HOME (SCROLLABLE CONTENT) -->
            <div id="screen-home" class="glass-panel p-0 w-full max-w-4xl mx-auto pointer-events-auto relative overflow-hidden md:overflow-visible">
                
                <!-- Cityscape Background (SVG) -->
                <div class="absolute inset-0 z-0 bg-blue-200 overflow-hidden rounded-xl pointer-events-none">
                    <svg width="100%" height="100%" preserveAspectRatio="none" xmlns="http://www.w3.org/2000/svg">
                        <defs>
                            <linearGradient id="skyGrad" x1="0%" y1="0%" x2="0%" y2="100%">
                                <stop offset="0%" style="stop-color:#87CEEB;stop-opacity:1" />
                                <stop offset="100%" style="stop-color:#E0F7FA;stop-opacity:1" />
                            </linearGradient>
                        </defs>
                        <rect width="100%" height="100%" fill="url(#skyGrad)"/>
                        <circle cx="85%" cy="20%" r="40" fill="#FDB813" stroke="#FFA500" stroke-width="2"/>
                        <g class="cloud-anim" fill="white" opacity="0.8">
                            <circle cx="10%" cy="20%" r="20"/>
                            <circle cx="15%" cy="25%" r="25"/>
                            <circle cx="20%" cy="20%" r="20"/>
                            <circle cx="60%" cy="15%" r="15"/>
                            <circle cx="65%" cy="18%" r="20"/>
                            <circle cx="70%" cy="15%" r="15"/>
                        </g>
                        <rect x="5%" y="50%" width="10%" height="50%" fill="#94a3b8"/>
                        <rect x="20%" y="40%" width="15%" height="60%" fill="#64748b"/>
                        <rect x="40%" y="55%" width="10%" height="45%" fill="#94a3b8"/>
                        <rect x="60%" y="45%" width="12%" height="55%" fill="#64748b"/>
                        <rect x="80%" y="50%" width="15%" height="50%" fill="#94a3b8"/>
                        <rect x="0%" y="60%" width="12%" height="40%" fill="#cbd5e1" stroke="#475569" stroke-width="2"/>
                        <rect x="15%" y="65%" width="10%" height="35%" fill="#e2e8f0" stroke="#475569" stroke-width="2"/>
                        <rect x="30%" y="55%" width="18%" height="45%" fill="#cbd5e1" stroke="#475569" stroke-width="2"/>
                        <rect x="55%" y="62%" width="15%" height="38%" fill="#e2e8f0" stroke="#475569" stroke-width="2"/>
                        <rect x="75%" y="58%" width="20%" height="42%" fill="#cbd5e1" stroke="#475569" stroke-width="2"/>
                        <rect x="32%" y="60%" width="4%" height="5%" fill="#fef08a" />
                        <rect x="38%" y="60%" width="4%" height="5%" fill="#fef08a" />
                        <rect x="32%" y="70%" width="4%" height="5%" fill="#fef08a" />
                        <rect x="38%" y="70%" width="4%" height="5%" fill="#fef08a" />
                        <rect x="0" y="85%" width="100%" height="15%" fill="#374151"/>
                        <line x1="0" y1="92%" x2="100%" y2="92%" stroke="white" stroke-width="4" stroke-dasharray="20,20"/>
                    </svg>
                    <div class="absolute inset-0 bg-white/70 backdrop-blur-sm"></div>
                </div>

                <!-- Content Container - Scrollable -->
                <div class="relative z-10 p-6 flex flex-col md:flex-row items-center justify-around gap-8 min-h-full overflow-y-auto">
                    <div class="flex-1 md:text-left text-center shrink-0">
                        <h1 class="game-title text-4xl md:text-6xl font-black text-blue-500 leading-none mb-2">
                            PHYSICS<br>
                            <span class="text-yellow-400">ADVENTURE</span>
                        </h1>
                        <h2 class="text-lg md:text-2xl font-black text-gray-800 border-b-4 border-black inline-block pb-1 mb-2">
                            Momentum & Impulse
                        </h2>
                        <p class="text-xs md:text-sm font-bold text-gray-600 bg-yellow-100 p-2 rounded border border-black shadow-sm mt-2 italic inline-block">
                            "Run with Speed, Win with Physics."
                        </p>
                    </div>
                    
                    <div class="flex-1 w-full max-w-sm space-y-4 shrink-0 pb-4">
                        <div class="bg-white p-4 rounded-xl border-4 border-black shadow-lg">
                            <input type="text" id="name-input" placeholder="Enter your name..." class="w-full text-center p-3 rounded-lg border-2 border-black focus:bg-yellow-50 outline-none text-lg font-bold mb-3">
                            <button id="btn-start" onclick="goToCharSelect()" class="btn-3d bg-blue-500 text-white font-black py-3 px-6 rounded-lg text-xl w-full uppercase shadow-md opacity-50 cursor-not-allowed" disabled>
                                START GAME
                            </button>
                        </div>
                        
                        <div id="leaderboard-container" class="bg-gray-100 rounded-xl p-3 border-4 border-black text-left h-48 overflow-y-auto">
                            <h3 class="text-xs font-black text-center text-black mb-2 uppercase bg-yellow-300 border border-black rounded p-0.5 sticky top-0 z-10 shadow-sm">üèÜ Top 5 Leaderboard</h3>
                            <ol id="leaderboard-list" class="list-decimal list-inside space-y-1 text-gray-800 font-bold text-xs">
                                <li class="p-1 bg-white border border-black rounded text-center">Loading...</li>
                            </ol>
                        </div>
                    </div>
                </div>
            </div>

            <!-- MAP -->
            <div id="screen-map" class="hidden glass-panel p-4 text-center w-full max-w-2xl mx-auto pointer-events-auto">
                <h1 class="text-2xl font-black text-blue-600 mb-2 tracking-tighter border-b-4 border-black inline-block px-4">PETA KOTA</h1>
                <p class="text-sm font-bold text-gray-700 mb-4 bg-yellow-100 border border-black p-2 rounded-lg inline-block shadow-sm">
                    Selesaikan 9 tantangan di peta untuk mencapai garis FINISH!
                </p>
                
                <div id="map-board">
                    <svg class="absolute inset-0 w-full h-full z-0" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 300">
                        <g id="deco-layer" opacity="0.7">
                            <rect x="10" y="10" width="30" height="50" fill="#a8a29e" rx="2"/>
                            <rect x="15" y="15" width="5" height="5" fill="#fde047"/>
                            <rect x="25" y="15" width="5" height="5" fill="#fde047"/>
                            <rect x="10" y="200" width="50" height="90" fill="#a8a29e" rx="2"/>
                            <rect x="20" y="210" width="10" height="10" fill="#fde047"/>
                            <rect x="40" y="210" width="10" height="10" fill="#fde047"/>
                            <rect x="480" y="70" width="60" height="50" fill="#a8a29e" rx="2"/>
                            <rect x="580" y="200" width="50" height="90" fill="#a8a29e" rx="2"/>
                            
                            <!-- Toko Roti (Pink) -->
                            <g>
                                <rect x="200" y="50" width="40" height="40" fill="#fbcfe8" rx="2"/>
                                <rect x="205" y="70" width="30" height="20" fill="#9d174d"/>
                                <rect x="210" y="55" width="20" height="10" fill="#fde047"/>
                            </g>
                            <!-- Apartemen (Biru) -->
                            <g>
                                <rect x="350" y="200" width="40" height="80" fill="#93c5fd" rx="2"/>
                                <rect x="355" y="205" width="10" height="10" fill="#fde047"/>
                                <rect x="375" y="205" width="10" height="10" fill="#fde047"/>
                                <rect x="355" y="225" width="10" height="10" fill="#fde047"/>
                                <rect x="375" y="225" width="10" height="10" fill="#fde047"/>
                                <rect x="355" y="245" width="10" height="10" fill="#fde047"/>
                                <rect x="375" y="245" width="10" height="10" fill="#fde047"/>
                            </g>
                            <!-- Kantor (Oranye) -->
                            <g>
                                <rect x="150" y="10" width="30" height="60" fill="#fb923c" rx="2"/>
                                <rect x="155" y="15" width="20" height="10" fill="#0c4a6e"/>
                                <rect x="155" y="30" width="20" height="10" fill="#0c4a6e"/>
                                <rect x="155" y="45" width="20" height="10" fill="#0c4a6e"/>
                            </g>
                            
                            <g><rect x="80" y="180" width="10" height="20" fill="#78350f"/><circle cx="85" cy="170" r="15" fill="#16a34a"/></g>
                            <g><rect x="300" y="180" width="10" height="20" fill="#78350f"/><circle cx="305" cy="170" r="15" fill="#16a34a"/></g>
                            <g><rect x="400" y="50" width="10" height="20" fill="#78350f"/><circle cx="405" cy="40" r="15" fill="#16a34a"/></g>
                            
                            <g>
                                <rect x="100" y="270" width="30" height="10" fill="#ef4444" rx="2"/>
                                <rect x="105" y="265" width="20" height="5" fill="#f87171" rx="1"/>
                                <circle cx="105" cy="280" r="4" fill="#1f2937"/>
                                <circle cx="125" cy="280" r="4" fill="#1f2937"/>
                            </g>
                            <g>
                                <rect x="500" y="150" width="30" height="10" fill="#3b82f6" rx="2"/>
                                <rect x="505" y="145" width="20" height="5" fill="#60a5fa" rx="1"/>
                                <circle cx="505" cy="160" r="4" fill="#1f2937"/>
                                <circle cx="525" cy="160" r="4" fill="#1f2937"/>
                            </g>
                        </g>

                        <!-- Jalur Ular Horizontal -->
                        <path d="M 50 250 L 450 250 Q 550 250 550 190 L 550 190 Q 550 130 450 130 L 150 130 Q 50 130 50 70 L 50 70 Q 50 30 100 30 L 550 30" 
                              fill="none" stroke="#d6d3d1" stroke-width="20" stroke-linecap="round" stroke-opacity="1" />
                        <!-- Outline Jalan -->
                        <path d="M 50 250 L 450 250 Q 550 250 550 190 L 550 190 Q 550 130 450 130 L 150 130 Q 50 130 50 70 L 50 70 Q 50 30 100 30 L 550 30" 
                              fill="none" stroke="#000" stroke-width="24" stroke-linecap="round" stroke-opacity="0.2" />
                        <path d="M 50 250 L 450 250 Q 550 250 550 190 L 550 190 Q 550 130 450 130 L 150 130 Q 50 130 50 70 L 50 70 Q 50 30 100 30 L 550 30" 
                              fill="none" stroke="#fff" stroke-width="2" stroke-dasharray="12 12" stroke-linecap="round" />
                    <!-- Pins: Posisi disesuaikan sedikit agar tidak mepet -->
                    <!-- ID dan Class di-update lewat JS, ini struktur dasar -->
                    <!-- Posisi Level 1 digeser sedikit ke kanan (60px) agar tidak kepotong -->
                    <div class="map-pin" style="left: 60px; top: 250px;" onclick="selectLevel(1)">1<span class="map-pin-label">Start</span></div>
                    <div class="map-pin locked" style="left: 200px; top: 250px;" onclick="selectLevel(2)">2</div>
                    <div class="map-pin locked" style="left: 350px; top: 250px;" onclick="selectLevel(3)">3</div>
                    <div class="map-pin locked" style="left: 500px; top: 250px;" onclick="selectLevel(4)">4</div>
                    <div class="map-pin locked" style="left: 550px; top: 160px;" onclick="selectLevel(5)">5</div>
                    <div class="map-pin locked" style="left: 400px; top: 130px;" onclick="selectLevel(6)">6</div>
                    <div class="map-pin locked" style="left: 250px; top: 130px;" onclick="selectLevel(7)">7</div>
                    <div class="map-pin locked" style="left: 100px; top: 130px;" onclick="selectLevel(8)">8</div>
                    <div class="map-pin locked" style="left: 250px; top: 30px;" onclick="selectLevel(9)">9</div>
                    <div class="map-pin finish locked" style="left: 550px; top: 30px;" onclick="selectLevel(10)">üèÅ</div>
                </div>
            </div>

            <!-- CHAR SELECT -->
            <div id="screen-char" class="hidden glass-panel p-6 text-center max-w-4xl mx-auto pointer-events-auto">
                <h2 class="text-2xl font-black text-black mb-6">Pilih Avatar Kamu</h2>
                <div class="grid grid-cols-2 gap-8">
                    <!-- Neko Chan -->
                    <div onclick="selectChar('neko')" class="cursor-pointer bg-white p-4 rounded-xl border-4 border-black hover:bg-pink-100 transition-transform hover:-translate-y-2 shadow-[4px_4px_0px_0px_rgba(0,0,0,1)] group flex flex-col items-center justify-center">
                        <div class="w-32 h-32 mb-2 transform group-hover:scale-110 transition-transform">
                             <!-- Simple SVG Preview for Neko -->
                             <svg viewBox="0 0 100 100" class="svg-icon">
                                <circle cx="50" cy="50" r="35" fill="#fce7f3" stroke="black" stroke-width="2"/>
                                <!-- Cat Ears -->
                                <path d="M20,30 L30,10 L50,30 Z" fill="#ec4899" stroke="black" stroke-width="2"/>
                                <path d="M80,30 L70,10 L50,30 Z" fill="#ec4899" stroke="black" stroke-width="2"/>
                                <!-- Face -->
                                <circle cx="35" cy="55" r="4" fill="#be185d"/>
                                <circle cx="65" cy="55" r="4" fill="#be185d"/>
                                <path d="M45,65 Q50,70 55,65" fill="none" stroke="black" stroke-width="2"/>
                             </svg>
                        </div>
                        <div class="font-black text-xl text-pink-600">Lucy</div>
                        
                    </div>
                    <!-- Star Kun -->
                    <div onclick="selectChar('star')" class="cursor-pointer bg-white p-4 rounded-xl border-4 border-black hover:bg-blue-100 transition-transform hover:-translate-y-2 shadow-[4px_4px_0px_0px_rgba(0,0,0,1)] group flex flex-col items-center justify-center">
                          <div class="w-32 h-32 mb-2 transform group-hover:scale-110 transition-transform">
                            <!-- Simple SVG Preview for Star -->
                            <svg viewBox="0 0 100 100" class="svg-icon">
                                <circle cx="50" cy="50" r="35" fill="#e0f2fe" stroke="black" stroke-width="2"/>
                                <!-- Star Hair Clip -->
                                <path d="M20,25 L30,40 L10,40 Z" fill="#facc15" stroke="black" stroke-width="2" transform="rotate(-30 20 25)"/>
                                <!-- Spiky Hair -->
                                <path d="M20,40 L30,10 L50,35 L70,10 L80,40" fill="none" stroke="#0ea5e9" stroke-width="4" stroke-linecap="round"/>
                                <!-- Face -->
                                <circle cx="35" cy="55" r="4" fill="#0284c7"/>
                                <circle cx="65" cy="55" r="4" fill="#0284c7"/>
                                <path d="M45,65 Q50,70 55,65" fill="none" stroke="black" stroke-width="2"/>
                            </svg>
                        </div>
                        <div class="font-black text-xl text-blue-600">Luke</div>
                        
                    </div>
                </div>
            </div>

            <!-- VIDEO MODAL -->
            <div id="screen-video" class="hidden glass-panel w-full max-w-3xl mx-auto p-6 pointer-events-auto relative shadow-2xl z-50 flex flex-col items-center">
                <div class="absolute -top-4 bg-blue-600 text-white px-6 py-2 rounded-full border-2 border-black font-black tracking-wider shadow-md">
                    üé• OBSERVASI FISIKA
                </div>
                <h3 class="text-xl font-black mt-4 mb-2 text-center">Analisis Kecelakaan</h3>
                <p id="video-narrative" class="text-sm font-bold text-gray-700 mb-4 text-center max-w-xl whitespace-pre-line"></p>
                
                <div class="w-full max-w-lg bg-black rounded-lg overflow-hidden border-4 border-gray-800 shadow-lg mb-6 relative aspect-video flex items-center justify-center">
                    <video id="level-video" width="100%" height="100%" controls class="block" poster="https://cdn.pixabay.com/photo/2017/06/27/06/38/crash-test-2446271_1280.jpg">
                        <source src="https://cdn.videvo.net/videvo_files/converted/2018_01/preview/171124_H1_006.mp4" type="video/mp4">
                        <div class="text-white p-4">Browser Anda tidak mendukung tag video.</div>
                    </video>
                </div>

                <button onclick="proceedToQuestion()" class="btn-3d bg-yellow-400 text-black font-black py-3 px-8 rounded-xl text-xl uppercase shadow-black border-2 border-black animate-pulse">
                    Lanjutkan ke Soal ‚û°Ô∏è
                </button>
            </div>

            <!-- QUIZ MODAL -->
            <div id="screen-quiz" class="hidden glass-panel w-full max-w-5xl mx-auto p-4 md:p-6 pointer-events-auto relative shadow-2xl" oncontextmenu="return false;">
                <div class="absolute -top-4 left-1/2 transform -translate-x-1/2 bg-yellow-400 text-black px-6 py-1.5 rounded-full border-2 border-black font-black tracking-wider flex items-center gap-2 z-10 shadow-md text-sm md:text-base">
                    <span>üöß</span> TANTANGAN <span id="quiz-level-num">1</span>
                </div>
                
                <div id="quiz-content" class="mt-4">
                    <div class="flex flex-col md:flex-row gap-6 items-stretch justify-center">
                            
                            <!-- KOLOM KIRI: Visual / Cutscene / Simulasi -->
                            <div id="quiz-options-cutscene" class="hidden w-full md:w-7/12 flex-shrink-0 border-b-2 md:border-b-0 md:border-r-2 border-dashed border-gray-300 pb-4 md:pb-0 md:pr-4 bg-gray-50 rounded flex flex-col justify-center">
                                <!-- Konten simulasi akan disuntikkan di sini oleh JS -->
                            </div>

                            <!-- KOLOM KANAN: Pertanyaan & Input -->
                            <div class="w-full flex-grow flex flex-col gap-3 justify-center">
                                <div id="quiz-question-container" class="bg-blue-100 border-2 border-black p-4 rounded-xl text-black hidden shadow-sm">
                                    <p id="quiz-question" class="font-bold text-base md:text-lg leading-snug text-center">Memuat pertanyaan...</p>
                                </div>

                                <!-- Opsi Jawaban -->
                                <div class="flex-grow flex flex-col justify-center gap-3">
                                    <!-- MCQ -->
                                    <div id="quiz-options-mcq" class="space-y-2 hidden"></div>

                                    <!-- Slider -->
                                    <div id="quiz-options-slider" class="space-y-4 hidden bg-gray-100 p-4 rounded-xl border-2 border-black">
                                        <div class="flex justify-between font-black text-xs uppercase tracking-widest">
                                            <span id="slider-label-left" class="text-blue-600">Kiri</span>
                                            <span id="slider-label-right" class="text-red-600">Kanan</span>
                                        </div>
                                        <input type="range" id="quiz-slider" min="1" max="2" value="1.5" class="w-full accent-black h-6 bg-gray-300 rounded-full appearance-none border-2 border-black cursor-pointer">
                                        <div class="text-center">
                                            <span id="slider-value" class="text-2xl font-black text-white bg-black px-4 py-1 rounded-lg shadow-md">1.5</span>
                                        </div>
                                    </div>

                                    <!-- Input Kalkulasi (Single) -->
                                    <div id="quiz-options-input" class="hidden space-y-2 bg-gray-100 p-4 rounded-xl border-2 border-black">
                                        <label class="block text-xs font-black text-gray-500 uppercase tracking-wider text-center">Masukkan Jawaban (Angka):</label>
                                        <div class="flex items-center gap-2">
                                            <input type="number" id="quiz-number-input" placeholder="0" class="w-full p-3 text-2xl font-black text-center border-2 border-black rounded-lg focus:bg-yellow-50 outline-none shadow-inner">
                                            <span class="text-sm font-bold text-gray-500 w-12">Unit (N)</span>
                                        </div>
                                    </div>

                                    <!-- NEW: Input Esai Singkat (Teks) -->
                                    <div id="quiz-options-text" class="hidden space-y-2 bg-gray-100 p-4 rounded-xl border-2 border-black">
                                        <label class="block text-xs font-black text-gray-500 uppercase tracking-wider text-center">Jawab Singkat:</label>
                                        <input type="text" id="quiz-text-input" placeholder="Ketik jawabanmu di sini..." class="w-full p-3 text-lg font-bold text-center border-2 border-black rounded-lg focus:bg-yellow-50 outline-none shadow-inner" autocomplete="off">
                                        <p class="text-[10px] text-gray-500 text-center italic">*Pastikan ejaan benar</p>
                                    </div>

                                     <!-- Input Kalkulasi (Multi) -->
                                     <div id="quiz-options-multi-input" class="hidden space-y-3 bg-gray-100 p-4 rounded-xl border-2 border-black"></div>
                                </div>
                                
                                <!-- Tombol & Feedback -->
                                <div class="mt-auto">
                                    <button id="quiz-submit-btn" onclick="checkAnswer()" class="btn-3d bg-green-500 text-white font-black py-3 px-6 rounded-xl text-xl w-full uppercase shadow-black border-2 border-black hover:bg-green-400">
                                        JAWAB SEKARANG
                                    </button>
                                    <p id="quiz-feedback" class="text-center font-black mt-3 min-h-[20px] text-sm leading-tight"></p>
                                </div>
                            </div>
                    </div>
                </div>
            </div>

            <!-- GAME OVER -->
            <div id="screen-gameover" class="hidden glass-panel p-8 text-center max-w-md mx-auto pointer-events-auto">
                <div class="text-8xl mb-4 animate-bounce">üíÄ</div>
                <h1 class="text-5xl font-black text-red-600 mb-4 tracking-tighter" style="-webkit-text-stroke: 2px black;">GAME OVER</h1>
                <button onclick="restartGame()" class="btn-3d bg-yellow-400 text-black font-black py-4 px-12 rounded-xl text-2xl w-full uppercase border-2 border-black shadow-[4px_4px_0px_0px_rgba(0,0,0,1)]">
                    Coba Lagi
                </button>
            </div>

            <!-- PESAN FINISH -->
            <div id="screen-finish-message" class="hidden glass-panel p-8 text-center max-w-lg mx-auto pointer-events-auto">
                <div class="text-8xl mb-4 animate-bounce">üèÜ</div>
                <h1 class="text-3xl font-black text-blue-500 mb-4 tracking-tighter" style="-webkit-text-stroke: 2px black;">
                    Congratulations, <span id="finish-player-name">Pemain</span>!
                </h1>
                
                <!-- NEW: STATS GRID -->
                <div class="grid grid-cols-2 gap-4 mb-4">
                     <div class="bg-green-100 p-3 rounded-xl border-4 border-green-600 shadow-md">
                        <div class="text-xs uppercase font-black text-green-800">Jawaban Benar</div>
                        <div id="finish-correct-count" class="text-4xl font-black text-green-600">0</div>
                     </div>
                     <div class="bg-red-100 p-3 rounded-xl border-4 border-red-600 shadow-md">
                        <div class="text-xs uppercase font-black text-red-800">Jawaban Salah</div>
                        <div id="finish-wrong-count" class="text-4xl font-black text-red-600">0</div>
                     </div>
                </div>

                <!-- NEW: REPORT LIST -->
                <div class="bg-white border-2 border-black rounded-xl p-3 mb-4 max-h-32 overflow-y-auto text-left shadow-inner">
                    <h3 class="font-black text-xs uppercase border-b-2 border-gray-200 mb-2 pb-1 sticky top-0 bg-white">Rincian Jawaban:</h3>
                    <ul id="finish-details-list" class="space-y-2 text-xs">
                        <!-- Items injected by JS -->
                    </ul>
                </div>

                <div class="flex gap-2 justify-center mb-6">
                    <button onclick="downloadReport()" class="btn-3d bg-purple-500 text-white font-bold py-2 px-4 rounded-lg text-lg border-2 border-black flex items-center gap-2 hover:bg-purple-400 shadow-[4px_4px_0px_0px_rgba(0,0,0,1)]">
                        üìÑ Download Rapor
                    </button>
                </div>

                <div class="text-sm md:text-base text-left bg-yellow-50 border-4 border-black p-3 rounded-xl mb-6 space-y-1 font-bold text-gray-800 shadow-inner">
                    <p>Total Skor Akhir: <strong id="finish-player-score" class="text-xl text-blue-600">0</strong></p>
                </div>

                <button onclick="goHome()" class="btn-3d bg-blue-500 text-white font-black py-4 px-12 rounded-xl text-2xl w-full uppercase border-2 border-black shadow-[4px_4px_0px_0px_rgba(0,0,0,1)]">
                    Kembali ke Menu
                </button>
            </div>

            <!-- LEVEL UNLOCKED -->
            <div id="screen-nextlevel" class="hidden glass-panel p-8 text-center max-w-md mx-auto pointer-events-auto">
                <div class="text-8xl mb-4 animate-bounce">üó∫Ô∏è</div>
                <h1 class="text-4xl font-black text-blue-500 mb-4 tracking-tighter" style="-webkit-text-stroke: 2px black;">LEVEL TERBUKA!</h1>
                
                <div class="bg-yellow-100 border-4 border-black p-4 rounded-xl mb-6">
                    <div class="text-sm uppercase font-bold text-gray-600">Kamu telah membuka:</div>
                    <div id="next-level-name" class="text-3xl font-black text-black">Level 2</div>
                </div>
    
                <button onclick="closeNextLevelScreen()" class="btn-3d bg-blue-500 text-white font-black py-4 px-12 rounded-xl text-2xl w-full uppercase border-2 border-black shadow-[4px_4px_0px_0px_rgba(0,0,0,1)]">
                    LANJUTKAN
                </button>
            </div>

            <!-- PERATURAN GAME -->
            <div id="screen-rules" class="hidden glass-panel p-8 text-center max-w-lg mx-auto pointer-events-auto">
                <h1 class="text-3xl font-black text-blue-600 mb-6 tracking-tighter" style="-webkit-text-stroke: 2px black;">PERATURAN GAME</h1>
                
                <ul class="text-left bg-yellow-50 border-4 border-black p-6 rounded-xl mb-8 space-y-4 text-sm md:text-base font-bold text-gray-800 list-none shadow-inner">
                    <li class="flex items-start gap-3">
                        <span class="text-2xl mt-[-2px]">üöó</span>
                        <div><strong>Tujuan:</strong> Capai garis FINISH dengan menjawab semua tantangan fisika.</div>
                    </li>
                    <li class="flex items-start gap-3">
                        <span class="text-2xl mt-[-2px]">üöß</span>
                        <div><strong>Rintangan:</strong> Tabrak rintangan untuk memulai kuis tantangan.</div>
                    </li>
                    <li class="flex items-start gap-3">
                        <span class="text-2xl mt-[-2px]">‚úÖ</span>
                        <div><strong class="text-green-600">Jawaban Benar:</strong> Membuka gerbang dan menambah <strong class="text-green-600">(+10 Poin)</strong>.</div>
                    </li>
                    <li class="flex items-start gap-3">
                        <span class="text-2xl mt-[-2px]">‚ùå</span>
                        <div><strong class="text-red-600">Jawaban Salah:</strong> Poin akan berkurang <strong class="text-red-600">(-5 Poin)</strong>. Tapi tenang, kamu bisa coba lagi!</div>
                    </li>
                    <li class="flex items-start gap-3">
                        <span class="text-2xl mt-[-2px]">üèÜ</span>
                        <div><strong>Skor:</strong> Kumpulkan poin sebanyak-banyaknya untuk masuk Leaderboard!</div>
                    </li>
                </ul>

                <button onclick="startGame()" class="btn-3d bg-green-500 text-white font-black py-4 px-12 rounded-xl text-2xl w-full uppercase border-2 border-black shadow-[4px_4px_0px_0px_rgba(0,0,0,1)] animate-pulse">
                    MULAI!
                </button>
            </div>

        </div>

        <!-- Mobile Controls -->
        <div id="dpad" class="hidden absolute bottom-4 left-4 z-30 pointer-events-auto opacity-80">
            <div class="relative w-40 h-40">
                <div id="dpad-up" class="dpad-btn absolute top-0 left-1/2 -translate-x-1/2 w-14 h-14 text-xl">‚¨ÜÔ∏è</div>
                <div id="dpad-left" class="dpad-btn absolute left-0 top-1/2 -translate-y-1/2 w-14 h-14 text-xl">‚¨ÖÔ∏è</div>
                <div id="dpad-right" class="dpad-btn absolute right-0 top-1/2 -translate-y-1/2 w-14 h-14 text-xl">‚û°Ô∏è</div>
                <div id="dpad-down" class="dpad-btn absolute bottom-0 left-1/2 -translate-x-1/2 w-14 h-14 text-xl">‚¨áÔ∏è</div>
            </div>
        </div>
    </div>

    <!-- SCRIPT FIREBASE & GAME LOGIC -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, addDoc, setDoc, onSnapshot, collection, query, getDocs, limit, where, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- CONFIG & STATE ---
        let db, auth, userId, unsubLeaderboard;
        // Adjusted mainVol from 0 to -10 (quieter default)
        // GANTI bgmSynth/bgmLoop dengan bgmPlayer
        let mainVol, reverb, synthCorrect, synthWrong, synthLevelUp, bgmPlayer;
        
        // Setup global fallback for development environment if needed
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'physics-adventure';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;

        // Constants
        const TILE_SIZE = 40;
        const ROAD_HEIGHT = 300; // Total lebar jalan (atas ke bawah)
        const ROAD_HALF = ROAD_HEIGHT / 2;
        
        // --- NEW: SISTEM GAMBAR KUSTOM ---
        const loadedImages = {}; // Tempat menyimpan gambar yang sudah di-download browser
        
        // KONFIGURASI LINK GAMBAR (GANTI LINK INI DENGAN RAW LINK GITHUB ANDA)
        const imageSources = {
            // Contoh: Mengganti bola hijau (tree) dengan gambar Pohon Kartun
            // Link ini adalah contoh placeholder. Ganti dengan link raw github Anda.
            'tree': 'https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/other/official-artwork/185.png', // Contoh: Sudowoodo (mirip pohon)
            
            // Contoh: Mengganti kotak gedung dengan gambar Gedung
            // 'building': 'https://raw.githubusercontent.com/username/repo/main/building.png',
            
            // Jika Anda ingin karakter pemain pakai gambar, isi ini:
            // 'player_neko': 'LINK_GAMBAR_NEKO',
            // 'player_star': 'LINK_GAMBAR_STAR'
        };

        const state = {
            currentLevel: 1,
            maxLevel: 1,
            playerName: "Noob",
            playerType: "neko", // Default to Neko
            score: 0,
            correctAnswers: 0, // NEW: Counter Benar
            wrongAnswers: 0,   // NEW: Counter Salah
            levelResults: [], // NEW: Menyimpan detail hasil per level
            gameActive: false,
            quizActive: false,
            quizStartTime: 0,
            gameFinished: false,
            finishTime: 0,
            crossingAction: null, // NEW STATE: Handles auto-pilot animation
            player: { x: 0, y: 0, speed: 6, width: 40, height: 40, vx: 0, vy: 0, jumpOffset: 0 }, // Speed sedikit dinaikkan agar enak di tikungan
            camera: { x: 0 },
            startLineX: 0,
            worldObjects: [],
            triggers: [],
            gates: [],
            // --- URUTAN LEVEL BARU (MUDAH -> SUSAH) ---
            checkpoints: [
                // LEVEL 1: HITUNGAN MOMENTUM DASAR (p = mv) - PALING MUDAH
                { 
                    id: 1, x: 1000, type: 'calc', visual: 'river', 
                    question: "Jembatan putus! Mobil bermassa 1.500 kg melaju dengan kecepatan 20 m/s. Hitung momentum mobil tersebut!", 
                    sim: {}, 
                    options: { 
                        input: { correctValue: 30000, tolerance: 0 }, 
                        feedback: { correct: "Tepat! P = m.v", wrong: "Rumus: p = massa x kecepatan" }, 
                        explanation: "p = 1500 kg * 20 m/s = 30.000 kg.m/s" 
                    } 
                },

                // LEVEL 2: HITUNGAN IMPULS DASAR (I = F.dt) - MUDAH
                { 
                    id: 2, x: 2000, type: 'calc', visual: 'cliff', 
                    question: "Tebing Es! Tahan tubuhmu dengan gaya 200 N selama 5 detik agar tidak jatuh. Berapa IMPULS yang kamu kerjakan?", 
                    sim: {}, 
                    options: { 
                        input: { correctValue: 1000, tolerance: 0 }, 
                        feedback: { correct: "Kuat sekali!", wrong: "Rumus: I = Gaya x Waktu" }, 
                        explanation: "I = 200 N * 5 s = 1000 N.s" 
                    } 
                },

                // LEVEL 3: HITUNGAN GAYA IMPULSIF - MEDIUM-MUDAH
                { 
                    id: 3, x: 3000, type: 'calc', visual: 'spike', 
                    question: "Benda bermassa 2 kg jatuh ke lantai dengan kecepatan 10 m/s dan berhenti dalam waktu 0,1 detik. Hitung GAYA rata-rata (N) yang diterima lantai!", 
                    sim: {}, 
                    options: { 
                        input: { correctValue: 200, tolerance: 5 }, 
                        feedback: { 
                            correct: "Hebat! F = I / Œît", 
                            wrong: "Rumus: F = (m . Œîv) / Œît" 
                        },
                        explanation: "Impuls (I) = m.Œîv = 2.10 = 20. Gaya (F) = I/t = 20/0.1 = 200 N."
                    } 
                },

                // LEVEL 4: TUMBUKAN TIDAK LENTING (MOBIL & BECAK) - MEDIUM
                { 
                    id: 4, x: 4000, type: 'calc', visual: 'accident', 
                    question: "Sebuah mobil bermassa 2000 kg melaju dengan kecepatan 120 km/jam, menabrak sebuah becak bermassa 500 kg yang diam. Berapa kecepatan mobil dan becak setelah tumbukan? (km/jam)", 
                    sim: {
                        type: 'image',
                        src: 'https://raw.githubusercontent.com/ayaa-code/ayaa/49761724ce6d09bcef619d33989a1d464d74c5af/Gambar%20WhatsApp%202025-11-25%20pukul%2016.14.29_5b61a77c.jpg'
                    }, 
                    options: { 
                        input: { correctValue: 96, tolerance: 1 }, 
                        feedback: { 
                            correct: "Tepat! Momentum Awal = Momentum Akhir.", 
                            wrong: "Gunakan Rumus: (m1.v1 + m2.v2) = (m1+m2).v'" 
                        }, 
                        explanation: "P_awal = (2000*120) + (500*0) = 240.000. Massa Total = 2500. v' = 240.000 / 2500 = 96 km/jam." 
                    } 
                },

                // LEVEL 5: TUMBUKAN TIDAK LENTING SEMPURNA - SMA KELAS 11 - MEDIUM-SULIT
                { 
                    id: 5, x: 5000, type: 'calc', visual: 'mud', 
                    question: "Sebuah bola bermassa 3 kg bergerak dengan kecepatan 8 m/s menabrak bola lain yang bermassa 2 kg yang bergerak berlawanan arah dengan kecepatan 4 m/s. Jika kedua bola melekat setelah tumbukan, hitung kecepatan akhir kedua bola tersebut (m/s)!", 
                    sim: {}, 
                    options: { 
                        input: { correctValue: 3.2, tolerance: 0.2 }, 
                        feedback: { 
                            correct: "Hebat! Momentum terjaga! I = Œîp", 
                            wrong: "Gunakan Hukum Kekekalan Momentum untuk tumbukan tidak lenting." 
                        },
                        explanation: "m1v1 + m2v2 = (m1+m2)v'. (3√ó8) + (2√ó(-4)) = (3+2)v'. 24 - 8 = 5v'. v' = 3.2 m/s"
                    } 
                },

                // LEVEL 6: TUMBUKAN TIDAK LENTING (Menempel) - SULIT
                { 
                    id: 6, x: 6000, type: 'calc', visual: 'truck', 
                    question: "Mobil A (2kg, 8m/s) menabrak Truk B (4kg, diam) dan MENEMPEL. Hitung kecepatan akhirnya (v')!", 
                    sim: {}, 
                    options: { 
                        input: { correctValue: 2.67, tolerance: 0.1 }, 
                        feedback: { correct: "Benar! Mereka bergerak bersama.", wrong: "Rumus: m1v1 + m2v2 = (m1+m2)v'" }, 
                        explanation: "(2*8) + (4*0) = (2+4)v' -> 16 = 6v' -> v' = 2.67 m/s" 
                    } 
                },

                // LEVEL 7: RECOIL / LEDAKAN (Aksi-Reaksi) - SULIT
                { 
                    id: 7, x: 7000, type: 'calc', visual: 'croc', 
                    question: "Di atas rakit (20kg) diam. Kamu (50kg) lompat ke depan v=4 m/s. Berapa kecepatan rakit MUNDUR? (tulis angkanya saja)", 
                    sim: {}, 
                    options: { 
                        input: { correctValue: 10, tolerance: 0.1 }, 
                        feedback: { correct: "Cerdas! Aksi-Reaksi.", wrong: "P_awal = 0 -> m1v1 + m2v2 = 0" }, 
                        explanation: "0 = (50*4) + (20*v2) -> -200 = 20v2 -> v2 = -10 m/s. Kelajuan = 10." 
                    } 
                },

                // LEVEL 8: IMPULS VEKTOR (Memantul Balik) - SANGAT SULIT
                { 
                    id: 8, x: 8000, type: 'calc', visual: 'wall', 
                    question: "Bola 0,5 kg menumbuk tembok v=10 m/s, memantul balik v=-10 m/s dalam 0,1 detik. Hitung GAYA rata-ratanya (N)!", 
                    sim: {}, 
                    options: { 
                        input: { correctValue: 100, tolerance: 5 }, 
                        feedback: { correct: "Luar biasa! Hati-hati dengan tanda minus.", wrong: "F = m(v2 - v1) / t" }, 
                        explanation: "Œîv = -10 - 10 = -20. F = 0.5(-20)/0.1 = -100 N. Besar gaya = 100 N." 
                    } 
                },

                // LEVEL 9: TUMBUKAN LENTING SEMPURNA (Simulasi Kompleks) - PALING SULIT
                // Menggunakan visual Bumper Car karena relevan dengan lenting
                { 
                    id: 9, x: 9000, type: 'calc-multi', visual: 'bumper', 
                    question: "Arena Bumper Car! Atur simulasi di samping dan hitung kecepatan akhir (v1' dan v2') untuk Tumbukan Lenting Sempurna.", 
                    sim: { type: 'q1-momentum-interactive' }, 
                    options: { 
                        inputs: [
                            { id: 'ans-v1', label: "Kecepatan Akhir Benda 1 (v1')", unit: "m/s" }, 
                            { id: 'ans-v2', label: "Kecepatan Akhir Benda 2 (v2')", unit: "m/s" }
                        ], 
                        feedback: { 
                            correct: "Sempurna! Kamu telah menaklukkan materi Momentum!", 
                            wrong: "Petunjuk Rumus Tumbukan Lenting Sempurna: v1' = ((m1-m2)v1 + 2m2v2) / (m1+m2) dan v2' = ((m2-m1)v2 + 2m1v1) / (m1+m2)" 
                        } 
                    } 
                },
                
                // FINISH
                { id: 10, x: 10000, type: 'finish', visual: 'gate' }
            ],
            currentCheckpoint: null
        };

        const keys = { w: false, a: false, s: false, d: false };

        // --- NEW: FUNGSI LEKUKAN JALAN ---
        // Menghasilkan posisi Y tengah jalan berdasarkan posisi X
        function getRoadCurve(x) {
            // Menggunakan kombinasi Sinus untuk membuat jalan bergelombang tidak monoton
            // Periode panjang (x/1200) + Periode pendek (x/400)
            return (Math.sin(x / 800) * 150) + (Math.sin(x / 300) * 30);
        }

        // --- INIT ---
        window.onload = () => {
            // Parse Firebase config dari __firebase_config (dari firebase-config.js)
            let firebaseConfig = null;
            if (typeof __firebase_config !== 'undefined' && __firebase_config) {
                try {
                    firebaseConfig = JSON.parse(__firebase_config);
                    console.log("‚úÖ Firebase config found!");
                } catch (e) {
                    console.error("‚ùå Error parsing Firebase config:", e);
                }
            }

            if (firebaseConfig) {
                initFirebase(firebaseConfig);
            } else {
                console.warn("‚ö†Ô∏è Firebase config not found. Running in Offline mode.");
                userId = 'offline';
                // Jangan tampilkan pesan offline, biarkan user bermain
                document.getElementById('leaderboard-list').innerHTML = '<li class="p-1 bg-white border border-black rounded text-center text-gray-500 italic">Leaderboard tidak tersedia</li>';
                document.getElementById('btn-start').disabled = false;
                document.getElementById('btn-start').classList.remove('opacity-50', 'cursor-not-allowed');
            }
            
            // LOAD GAMBAR SEBELUM GAME DIMULAI
            preloadImages();
            
            initAudio();
            initGame2D();
            initControls();
            initUI();
        };

        // FUNGSI BARU: Memuat semua gambar dari daftar imageSources
        function preloadImages() {
            for (const [key, url] of Object.entries(imageSources)) {
                if (url) {
                    const img = new Image();
                    img.src = url;
                    img.onload = () => {
                        console.log(`Gambar [${key}] berhasil dimuat.`);
                        loadedImages[key] = img;
                    };
                    img.onerror = () => {
                        console.error(`Gagal memuat gambar [${key}]. Cek Link Raw-nya.`);
                    };
                }
            }
        }

        async function initFirebase(config) {
            try {
                console.log("üîÑ Initializing Firebase with config...", config.projectId);
                const app = initializeApp(config);
                db = getFirestore(app);
                auth = getAuth(app);
                
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        console.log("‚úÖ Firebase Auth success! User:", userId);
                        await loadPlayerData();
                    } else {
                        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                            await signInWithCustomToken(auth, __initial_auth_token);
                        } else {
                            console.log("üîê Signing in anonymously...");
                            await signInAnonymously(auth);
                        }
                    }
                    loadLeaderboard();
                });
            } catch (e) {
                console.error("Firebase Error:", e);
            }
        }

        // --- AUDIO SYSTEM ---
        function initAudio() {
            // Volume utama (untuk semua suara)
            mainVol = new Tone.Volume(-10).toDestination(); 
            reverb = new Tone.Reverb(1).connect(mainVol);
            
            // SFX (Efek Suara)
            synthCorrect = new Tone.Synth({ oscillator: { type: "triangle" }, envelope: { attack: 0.01, decay: 0.1, sustain: 0.2, release: 0.2 } }).connect(reverb);
            synthWrong = new Tone.Synth({ oscillator: { type: "square" }, envelope: { attack: 0.01, decay: 0.2, sustain: 0, release: 0.1 } }).connect(reverb);
            synthLevelUp = new Tone.FMSynth({ envelope: { attack: 0.01, decay: 0.2, sustain: 0.1, release: 0.3 } }).connect(reverb);
            
            // --- BGM (BACKGROUND MUSIC) DARI GITHUB ---
            // PERBAIKAN: Menggunakan link raw.githubusercontent.com agar tidak kena blokir redirect/CORS
            // Link Asli: https://github.com/tqch320/liyaaa/raw/refs/heads/main/pad-happy-dayz-are-ahead-236456.mp3
            // Link Fix:
            const bgmURL = "https://raw.githubusercontent.com/tqch320/liyaaa/refs/heads/main/pad-happy-dayz-are-ahead-236456.mp3";

            bgmPlayer = new Tone.Player({
                url: bgmURL,
                loop: true,
                autostart: false,
                volume: -10, // Volume dinaikkan sedikit
                onload: () => {
                    console.log("Musik Background Berhasil Dimuat!");
                    const statusEl = document.getElementById('music-status');
                    if (statusEl) {
                        statusEl.innerText = "‚úÖ Musik Siap Dimainkan!";
                        statusEl.classList.remove('text-orange-500', 'animate-pulse');
                        statusEl.classList.add('text-green-600');
                    }
                    // Jika game sudah jalan duluan sebelum musik load, nyalakan sekarang
                    if (state.gameActive && !state.quizActive) {
                        bgmPlayer.start();
                    }
                },
                onerror: (e) => {
                    console.error("Gagal memuat musik:", e);
                    const statusEl = document.getElementById('music-status');
                    if (statusEl) {
                        statusEl.innerText = "‚ùå Gagal memuat musik (Cek koneksi/Link)";
                        statusEl.classList.remove('text-orange-500');
                        statusEl.classList.add('text-red-600');
                    }
                }
            }).toDestination();
            
            Tone.Transport.bpm.value = 120;
        }

        // Fungsi untuk mengontrol musik latar
        function toggleBGM(play) {
            // Cek apakah player ada
            if (!bgmPlayer) return;
            
            // Cek apakah player sudah loaded. Jika belum, jangan error, biarkan onload nanti yang handle.
            if (!bgmPlayer.loaded) {
                console.log("Musik belum selesai download, menunggu...");
                return;
            }

            if (play) {
                // Pastikan Audio Context berjalan (PENTING untuk browser modern)
                if (Tone.context.state !== 'running') {
                    Tone.start().then(() => {
                        if (bgmPlayer.state !== "started") bgmPlayer.start();
                    });
                } else {
                    if (bgmPlayer.state !== "started") bgmPlayer.start();
                }
            } else {
                if (bgmPlayer.state === "started") bgmPlayer.stop();
            }
        }


        // --- GAME ENGINE ---
        let canvas, ctx;
        function initGame2D() {
            canvas = document.getElementById('game-canvas');
            ctx = canvas.getContext('2d');
            window.addEventListener('resize', resizeCanvas);
            resizeCanvas();
            requestAnimationFrame(gameLoop);
        }

        function resizeCanvas() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
        }

        function gameLoop() {
            if (state.gameActive && !state.quizActive) updatePhysics();
            render();
            requestAnimationFrame(gameLoop);
        }

        function updatePhysics() {
            // --- NEW: CROSSING ANIMATION (PRECISION UPDATE) ---
            if (state.crossingAction) {
                const p = state.player;
                const act = state.crossingAction;
                const now = Date.now();
                const progress = Math.min(1, (now - act.startTime) / act.duration);
                
                // Update player Y to follow road curve even during animation
                const currentRoadY = getRoadCurve(p.x);
                
                if (progress >= 1) {
                    // Animation finished
                    state.crossingAction = null;
                    p.jumpOffset = 0; 
                    p.x = act.endX; 
                    p.y = getRoadCurve(p.x); // Land on the road center
                    
                    // --- MODIFIKASI LOGIKA FINISH ---
                    // Jika checkpoint berikutnya adalah FINISH, jangan langsung selesai.
                    // Biarkan pemain jalan sendiri (gameActive = true).
                    if (state.currentCheckpoint && state.currentCheckpoint.type === 'finish') {
                        state.gameActive = true; 
                    } else {
                        // Jika bukan finish (level biasa), pause game dan tampilkan layar Level Up
                        state.gameActive = false; 
                        toggleBGM(false); // Stop BGM saat layar level up
                        setTimeout(() => {
                            document.getElementById('next-level-name').innerText = `Level ${state.currentLevel}`;
                            showScreen('screen-nextlevel');
                            if(synthLevelUp) {
                                const n = Tone.now();
                                synthLevelUp.triggerAttackRelease("C4","0.1",n); synthLevelUp.triggerAttackRelease("E4","0.1",n+0.1); synthLevelUp.triggerAttackRelease("G4","0.1",n+0.2); synthLevelUp.triggerAttackRelease("C5","0.2",n+0.3);
                            }
                        }, 1000);
                    }
                    return;
                }

                // Gerakan X Linear
                p.x = act.startX + (act.endX - act.startX) * progress;
                
                // Base Y follows the road curve
                // Jump Offset ditambahkan di atas posisi curve
                const baseY = getRoadCurve(p.x);
                
                // Hitung animasi Jump
                if (act.type === 'tree' || act.type === 'wall' || act.type === 'cliff') {
                    const h = act.type === 'cliff' ? 200 : 100;
                    if (progress < 0.2) p.jumpOffset = - (progress/0.2 * h);
                    else if (progress < 0.8) p.jumpOffset = -h;
                    else p.jumpOffset = -h * (1 - (progress-0.8)/0.2);
                } 
                else if (act.type === 'river') p.jumpOffset = -(Math.abs(Math.sin(progress * Math.PI * 3)) * 25);
                else if (act.type === 'spike') p.jumpOffset = -(Math.sin(progress * Math.PI) * 80);
                else if (act.type === 'cannon') p.jumpOffset = -(Math.sin(progress * Math.PI) * 200);
                else if (act.type === 'tunnel') p.jumpOffset = 0;
                else if (act.type === 'mud') p.jumpOffset = -20 - (Math.sin(progress * Math.PI * 4) * 5);
                else if (act.type === 'croc') p.jumpOffset = -(Math.sin(progress * Math.PI) * 60);
                else p.jumpOffset = -(Math.sin(progress * Math.PI) * 60);
                
                // Set absolute Y (Base Curve + Jump)
                p.y = baseY; // Drawing logic adds jumpOffset later
                
                // Camera Follow
                const targetCamX = p.x - canvas.width * 0.3;
                state.camera.x += (targetCamX - state.camera.x) * 0.1;
                return; 
            }
            // --- END NEW ANIMATION ---

            if (state.gameFinished) {
                const p = state.player;
                p.vx = p.speed;
                const roadY = getRoadCurve(p.x);
                // Tarik pemain ke tengah jalan saat finish
                p.vy = (roadY - p.y) * 0.1; 
                p.x += p.vx;
                p.y += p.vy;
                const targetCamX = p.x - canvas.width * 0.3;
                state.camera.x += (targetCamX - state.camera.x) * 0.1;

                if (Date.now() - state.finishTime > 2000) {
                    state.gameActive = false;
                    state.gameFinished = false;
                    toggleBGM(false); // Stop BGM saat finish
                    executeFinishSequence();
                }
                return;
            }

            const p = state.player;
            p.vx = 0; p.vy = 0;
            if (keys.d) p.vx = p.speed;
            if (keys.a) p.vx = -p.speed;
            if (keys.w) p.vy = -p.speed;
            if (keys.s) p.vy = p.speed;

            p.x += p.vx;
            p.y += p.vy;

            // --- ROAD BOUNDARIES (UPDATED FOR CURVES) ---
            // Sekarang batas jalan dihitung relatif terhadap curve di titik X pemain
            const currentCurveY = getRoadCurve(p.x);
            const topLimit = currentCurveY - ROAD_HALF + 40; // +40 buffer agar tidak keluar
            const bottomLimit = currentCurveY + ROAD_HALF - 40;

            if (p.y < topLimit) p.y = topLimit;
            if (p.y > bottomLimit) p.y = bottomLimit;
            if (p.x < state.startLineX - 50) p.x = state.startLineX - 50;

            // --- APPROACH DETECTION ---
            const STOP_DISTANCE = 80; 
            state.gates.forEach(gate => {
                if (!gate.open) {
                    const dist = gate.x - p.x;
                    let specificStop = STOP_DISTANCE;
                    if (gate.visual === 'river') specificStop = 120; 
                    if (gate.visual === 'spike') specificStop = 80;
                    if (gate.visual === 'cliff') specificStop = 60;
                    if (gate.visual === 'cannon') specificStop = 60;
                    if (gate.visual === 'croc') specificStop = 80;

                    // Deteksi tabrakan juga harus memperhitungkan Y, tapi karena ini gate penuh, cukup X
                    if (dist > 0 && dist < specificStop) {
                        p.vx = 0; 
                        p.x = gate.x - specificStop; 
                        triggerCheckpoint(gate.id);
                    }
                }
            });

            // Triggers
            state.triggers.forEach(t => {
                if (t.active) {
                    const dx = p.x - t.x;
                    const dy = p.y - (getRoadCurve(t.x) + t.y); // Trigger Y relative to curve
                    if (Math.sqrt(dx*dx + dy*dy) < 20 + t.radius) triggerCheckpoint(t.id);
                }
            });

            // Smooth Camera X
            const targetCamX = p.x - canvas.width * 0.3;
            state.camera.x += (targetCamX - state.camera.x) * 0.1;
            
            // Optional: Camera Y Follow (Agar jalanan tidak hilang dari layar saat melengkung jauh)
            // Kita ambil rata-rata curve di depan pemain
            const lookAheadY = getRoadCurve(p.x + 200);
            // Geser camera Y agar pemain tetap relatif di tengah vertikal
            // (canvas.height/2 default is 0 in our context translate, so we just translate context differently)
        }

        function triggerCheckpoint(id) {
            const cp = state.checkpoints.find(c => c.id === id);
            if (cp) {
                if (cp.type === 'finish') {
                    if (state.gameFinished) return;
                    state.gameFinished = true;
                    state.finishTime = Date.now();
                    const t = state.triggers.find(tr => tr.id === id);
                    if (t) t.active = false;
                } else {
                    state.gameActive = false;
                    toggleBGM(false); // Stop BGM saat kuis muncul
                    showQuiz(cp);
                }
            }
        }

        // --- RENDERING ---
        function render() {
            ctx.fillStyle = '#22c55e';
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            ctx.save();
            
            // CAMERA Y LOGIC: Follow the road curve roughly
            // Kita geser world vertikal berlawanan dengan curve pemain agar pemain tetap di tengah layar
            const camYOffset = -getRoadCurve(state.player.x + 100) * 0.8; 
            
            ctx.translate(-state.camera.x, canvas.height / 2 + camYOffset);

            const renderStartX = state.camera.x;
            const renderEndX = state.camera.x + canvas.width;
            
            // --- DRAW CURVED ROAD (POLYGON STRIP) ---
            // Kita gambar jalan per segmen kecil agar terlihat melengkung halus
            const step = 20; // Resolusi jalan
            
            // 1. Jalan Aspal
            ctx.beginPath();
            ctx.fillStyle = '#6b7280';
            // Sisi Atas Jalan
            for (let x = renderStartX - 100; x <= renderEndX + 100; x += step) {
                const y = getRoadCurve(x);
                ctx.lineTo(x, y - ROAD_HALF);
            }
            // Sisi Bawah Jalan (balik arah)
            for (let x = renderEndX + 100; x >= renderStartX - 100; x -= step) {
                const y = getRoadCurve(x);
                ctx.lineTo(x, y + ROAD_HALF);
            }
            ctx.closePath();
            ctx.fill();

            // 2. Pinggiran Jalan (Kerb) & Garis Tengah
            for (let x = renderStartX - 100; x <= renderEndX + 100; x += step) {
                const xNext = x + step;
                const y = getRoadCurve(x);
                const yNext = getRoadCurve(xNext);

                // Kerb Atas
                ctx.fillStyle = (Math.floor(x / 40) % 2 === 0) ? '#d1d5db' : '#9ca3af';
                ctx.beginPath();
                ctx.moveTo(x, y - ROAD_HALF - 20); ctx.lineTo(xNext, yNext - ROAD_HALF - 20);
                ctx.lineTo(xNext, yNext - ROAD_HALF); ctx.lineTo(x, y - ROAD_HALF);
                ctx.fill();
                
                // Kerb Bawah
                ctx.beginPath();
                ctx.moveTo(x, y + ROAD_HALF); ctx.lineTo(xNext, yNext + ROAD_HALF);
                ctx.lineTo(xNext, yNext + ROAD_HALF + 20); ctx.lineTo(x, y + ROAD_HALF + 20);
                ctx.fill();

                // Garis Putih Tengah
                if (Math.floor(x / 40) % 2 === 0) {
                    ctx.strokeStyle = '#fff'; ctx.lineWidth = 4;
                    ctx.beginPath(); ctx.moveTo(x, y); ctx.lineTo(xNext, yNext); ctx.stroke();
                }
            }

            // Start Line
            if (state.startLineX > renderStartX - 100 && state.startLineX < renderEndX + 100) {
                 const startY = getRoadCurve(state.startLineX);
                 const boxSize = 20;
                 for (let i = 0; i < ROAD_HEIGHT / boxSize; i++) {
                     const drawY = startY - ROAD_HALF + i * boxSize;
                     ctx.fillStyle = i % 2 === 0 ? 'white' : 'black';
                     ctx.fillRect(state.startLineX, drawY, boxSize, boxSize);
                     ctx.fillStyle = i % 2 === 0 ? 'black' : 'white';
                     ctx.fillRect(state.startLineX + boxSize, drawY, boxSize, boxSize);
                 }
            }

            // Objects (Draw with Y offset from curve)
            state.worldObjects.forEach(obj => {
                if (obj.x > renderStartX - 100 && obj.x < renderEndX + 100) {
                    // Hitung Y absolut berdasarkan Curve + Offset Y relatif objek
                    const roadY = getRoadCurve(obj.x);
                    // Simpan offset asli di properti baru jika belum ada, atau gunakan asumsi
                    // Asumsi: obj.y yang digenerate adalah offset dari 0.
                    // Jadi Absolute Y = roadY + obj.y
                    const drawY = roadY + obj.y;
                    
                    // Clone object untuk rendering agar tidak merusak data asli (atau pass parameter)
                    // Kita modifikasi fungsi drawObject agar terima y absolut
                    drawObject(obj, drawY); 
                }
            });

            // Finish Line Trigger Visual
            state.triggers.forEach(t => {
                if (t.active && t.id === 10 && t.x > renderStartX - 100 && t.x < renderEndX + 100) {
                    const tY = getRoadCurve(t.x);
                    const boxSize = 20;
                    for (let i = 0; i < ROAD_HEIGHT / boxSize; i++) {
                        const drawY = tY - ROAD_HALF + i * boxSize;
                        ctx.fillStyle = i % 2 === 0 ? 'white' : 'black';
                        ctx.fillRect(t.x, drawY, boxSize, boxSize);
                        ctx.fillStyle = i % 2 === 0 ? 'black' : 'white';
                        ctx.fillRect(t.x + boxSize, drawY, boxSize, boxSize);
                    }
                    ctx.save(); ctx.fillStyle = '#22c55e'; ctx.font = 'bold 30px Arial'; 
                    ctx.translate(t.x - 40, tY); // Center text vertically on road
                    ctx.rotate(-Math.PI/2); ctx.textAlign = 'center'; ctx.fillText("üèÅ FINISH üèÅ", 0, 0); ctx.restore();
                }
            });

            // Gates / Obstacles Rendering Update
            state.gates.forEach(g => {
                if (g.x > renderStartX - 100 && g.x < renderEndX + 100) {
                    const gY = getRoadCurve(g.x);
                    ctx.save();
                    ctx.translate(g.x, gY); // Translate ke tengah jalan yang melengkung

                    // CONFIG TEKS UMUM (Horizontal & Jelas)
                    ctx.fillStyle = 'white'; 
                    ctx.font = 'bold 16px Fredoka'; 
                    ctx.textAlign = 'center';
                    ctx.shadowColor = "black";
                    ctx.shadowBlur = 4;

                    if (g.visual === 'tree') {
                        // VISUAL: POHON TUMBANG (FULL BLOCK)
                        ctx.fillStyle = '#5c2b28'; ctx.shadowBlur=0; ctx.beginPath();
                        ctx.roundRect(-30, -ROAD_HALF - 10, 60, ROAD_HEIGHT + 20, 5); ctx.fill();
                        ctx.strokeStyle = '#3f1d1b'; ctx.lineWidth = 2; ctx.stroke();
                        ctx.fillStyle = '#16a34a';
                        ctx.beginPath(); ctx.arc(0, -ROAD_HALF - 10, 40, 0, Math.PI*2); ctx.fill();
                        ctx.beginPath(); ctx.arc(0, ROAD_HALF + 10, 40, 0, Math.PI*2); ctx.fill();
                        
                        // TEKS DI TENGAH
                        ctx.fillStyle = 'white'; ctx.shadowBlur=4;
                        ctx.fillText("POHON TUMBANG", 0, 5);

                    } else if (g.visual === 'accident') {
                        // VISUAL: KECELAKAAN (MOBIL vs BECAK)
                        ctx.save();
                        ctx.scale(1.6, 1.6); 
                        ctx.shadowBlur=0; // Reset shadow untuk gambar

                        // Mobil Merah
                        ctx.fillStyle = '#ef4444'; ctx.fillRect(-50, -30, 60, 40); 
                        ctx.strokeStyle = 'black'; ctx.lineWidth = 2; ctx.strokeRect(-50, -30, 60, 40);
                        ctx.fillStyle = 'black'; ctx.beginPath(); ctx.arc(-40, 15, 8, 0, Math.PI*2); ctx.fill(); ctx.beginPath(); ctx.arc(-10, 15, 8, 0, Math.PI*2); ctx.fill();

                        // Becak Biru
                        ctx.save(); ctx.translate(20, 0); ctx.rotate(0.2); 
                        ctx.fillStyle = '#3b82f6'; ctx.fillRect(0, -35, 40, 30); ctx.strokeStyle = 'black'; ctx.strokeRect(0, -35, 40, 30);
                        ctx.fillStyle = '#fbbf24'; ctx.beginPath(); ctx.moveTo(0, -35); ctx.lineTo(20, -50); ctx.lineTo(40, -35); ctx.fill(); ctx.stroke();
                        ctx.fillStyle = 'black'; ctx.beginPath(); ctx.arc(30, 10, 12, 0, Math.PI*2); ctx.fill();
                        ctx.restore();
                        ctx.restore(); 

                        // TEKS DI TENGAH (Font Besar)
                        ctx.fillStyle = 'white'; ctx.font = 'bold 24px Fredoka'; ctx.shadowBlur=4;
                        ctx.fillText("TABRAKAN", 0, 10);

                    } else if (g.visual === 'river') {
                        // VISUAL: SUNGAI
                        const riverWidth = 200; 
                        ctx.fillStyle = '#3b82f6'; ctx.shadowBlur=0; ctx.fillRect(-riverWidth/2, -ROAD_HALF - 20, riverWidth, ROAD_HEIGHT + 40);
                        ctx.strokeStyle = 'rgba(255,255,255,0.5)'; ctx.lineWidth = 3;
                        for(let y = -ROAD_HALF; y < ROAD_HALF; y+=40) { ctx.beginPath(); ctx.moveTo(-riverWidth/4, y); ctx.lineTo(riverWidth/4, y); ctx.stroke(); }
                        ctx.fillStyle = '#64748b'; ctx.strokeStyle = '#334155'; ctx.lineWidth = 2;
                        [-50, 0, 50].forEach(pos => { ctx.beginPath(); ctx.ellipse(pos, 0, 20, 15, 0, 0, Math.PI*2); ctx.fill(); ctx.stroke(); });
                        ctx.fillStyle = '#78350f'; ctx.fillRect(-(riverWidth/2 + 5), -ROAD_HALF - 20, 5, ROAD_HEIGHT+40); ctx.fillRect(riverWidth/2, -ROAD_HALF - 20, 5, ROAD_HEIGHT+40);
                        
                        // TEKS DI TENGAH
                        ctx.fillStyle = 'white'; ctx.shadowBlur=4;
                        ctx.fillText("SUNGAI DERAS", 0, 5);

                    } else if (g.visual === 'boulder') {
                        ctx.fillStyle = '#4b5563'; ctx.shadowBlur=0; ctx.strokeStyle = '#1f2937'; ctx.lineWidth = 2;
                        ctx.beginPath(); ctx.arc(0, 0, ROAD_HALF - 10, 0, Math.PI*2); ctx.fill(); ctx.stroke();
                        ctx.beginPath(); ctx.arc(-40, 60, 30, 0, Math.PI*2); ctx.fill(); ctx.stroke();
                        ctx.beginPath(); ctx.arc(30, -50, 40, 0, Math.PI*2); ctx.fill(); ctx.stroke();
                        
                        // TEKS DI TENGAH
                        ctx.fillStyle = 'white'; ctx.shadowBlur=4;
                        ctx.fillText("BATU BESAR", 0, 5);

                    } else if (g.visual === 'spike') {
                        const pitW = 80; 
                        ctx.fillStyle = '#292524'; ctx.shadowBlur=0;
                        ctx.fillRect(-pitW/2, -ROAD_HALF - 10, pitW, ROAD_HEIGHT + 20);
                        ctx.fillStyle = '#d1d5db'; 
                        for(let x = -pitW/2 + 5; x < pitW/2; x+=20) { for(let y = -ROAD_HALF + 20; y < ROAD_HALF; y+=40) { ctx.beginPath(); ctx.moveTo(x, y+10); ctx.lineTo(x+8, y-15); ctx.lineTo(x+16, y+10); ctx.fill(); }}
                        
                        // TEKS DI TENGAH
                        ctx.fillStyle = 'white'; ctx.shadowBlur=4;
                        ctx.fillText("LUBANG DURI", 0, 5);

                    } else if (g.visual === 'cliff') {
                        const cliffH = ROAD_HEIGHT + 60;
                        ctx.fillStyle = '#a5f3fc'; ctx.shadowBlur=0;
                        ctx.fillRect(-40, -cliffH/2, 80, cliffH);
                        ctx.strokeStyle = '#0891b2'; ctx.lineWidth = 2; ctx.strokeRect(-40, -cliffH/2, 80, cliffH);
                        ctx.strokeStyle = 'white'; ctx.lineWidth = 1;
                        ctx.beginPath(); ctx.moveTo(-30, -100); ctx.lineTo(0, -50); ctx.stroke();
                        ctx.beginPath(); ctx.moveTo(20, 50); ctx.lineTo(-10, 100); ctx.stroke();
                        
                        // TEKS DI TENGAH
                        ctx.fillStyle = '#164e63'; ctx.shadowBlur=0; // Teks gelap di background terang
                        ctx.fillText("TEBING ES", 0, 5);

                    } else if (g.visual === 'mud') {
                        ctx.fillStyle = '#78350f'; ctx.shadowBlur=0;
                        ctx.fillRect(-60, -ROAD_HALF - 20, 120, ROAD_HEIGHT + 40);
                        ctx.strokeStyle = '#92400e'; ctx.lineWidth = 3;
                        for(let i=0; i<5; i++) { const y = -100 + i*50; ctx.beginPath(); ctx.moveTo(-40, y); ctx.quadraticCurveTo(0, y+20, 40, y); ctx.stroke(); }
                        
                        // TEKS DI TENGAH
                        ctx.fillStyle = 'white'; ctx.shadowBlur=4;
                        ctx.fillText("BANJIR LUMPUR", 0, 5);

                    } else if (g.visual === 'wall') {
                        ctx.fillStyle = '#9ca3af'; ctx.shadowBlur=0;
                        ctx.fillRect(-20, -ROAD_HALF - 20, 40, ROAD_HEIGHT + 40);
                        ctx.strokeStyle = '#4b5563'; ctx.lineWidth = 2; ctx.strokeRect(-20, -ROAD_HALF - 20, 40, ROAD_HEIGHT + 40);
                        ctx.fillStyle = '#facc15'; 
                        for(let y = -ROAD_HALF; y < ROAD_HALF; y+=40) { ctx.beginPath(); ctx.moveTo(-20, y); ctx.lineTo(20, y+20); ctx.lineTo(20, y+10); ctx.lineTo(-20, y-10); ctx.fill(); }
                        
                        // TEKS DI TENGAH
                        ctx.fillStyle = 'white'; ctx.shadowBlur=4;
                        ctx.fillText("TEMBOK BETON", 0, 5);

                    } else if (g.visual === 'croc') {
                        const waterW = 120; 
                        ctx.fillStyle = '#064e3b'; ctx.shadowBlur=0;
                        ctx.fillRect(-waterW/2, -ROAD_HALF - 10, waterW, ROAD_HEIGHT + 20);
                        ctx.fillStyle = '#78350f'; ctx.fillRect(-30, -30, 60, 60); 
                        ctx.strokeStyle = '#451a03'; ctx.lineWidth = 2;
                        ctx.beginPath(); ctx.moveTo(-30, -10); ctx.lineTo(30, -10); ctx.stroke(); ctx.beginPath(); ctx.moveTo(-30, 10); ctx.lineTo(30, 10); ctx.stroke();
                        ctx.fillStyle = 'yellow'; [[-40, -50], [-30, 60], [40, -40], [30, 70]].forEach(pos => { ctx.beginPath(); ctx.arc(pos[0], pos[1], 3, 0, Math.PI*2); ctx.fill(); ctx.beginPath(); ctx.arc(pos[0]+8, pos[1], 3, 0, Math.PI*2); ctx.fill(); });
                        
                        // TEKS DI TENGAH
                        ctx.fillStyle = 'white'; ctx.shadowBlur=4;
                        ctx.fillText("KOLAM BUAYA", 0, 5);

                    } else if (g.visual === 'truck') {
                        ctx.fillStyle = '#e11d48'; ctx.shadowBlur=0;
                        ctx.fillRect(-30, -100, 60, 200);
                        ctx.strokeStyle = '#881337'; ctx.lineWidth = 2; ctx.strokeRect(-30, -100, 60, 200);
                        ctx.save(); ctx.translate(0, -110); ctx.rotate(-0.2);
                        ctx.fillStyle = '#f59e0b'; ctx.fillRect(-25, 0, 50, 40); ctx.restore();
                        
                        // TEKS DI TENGAH
                        ctx.fillStyle = 'white'; ctx.shadowBlur=4;
                        ctx.fillText("TRUK MOGOK", 0, 5);

                    } else if (g.visual === 'bumper') {
                        ctx.strokeStyle = '#60a5fa'; ctx.lineWidth = 5; ctx.shadowBlur=0;
                        ctx.beginPath(); let zig = -40; ctx.moveTo(zig, -ROAD_HALF);
                        for(let y = -ROAD_HALF; y <= ROAD_HALF; y+=20) { zig = (zig === -40) ? 40 : -40; ctx.lineTo(zig, y); }
                        ctx.stroke();
                        ctx.fillStyle = 'rgba(37, 99, 235, 0.8)'; ctx.fillRect(-10, -ROAD_HALF, 20, ROAD_HEIGHT);
                        
                        // TEKS DI TENGAH
                        ctx.fillStyle = 'white'; ctx.shadowBlur=4;
                        ctx.fillText("PEGAS", 0, 5);

                    } else {
                        ctx.fillStyle = '#ef4444'; ctx.shadowBlur=0;
                        ctx.fillRect(-10, -ROAD_HALF, 20, ROAD_HEIGHT);
                        ctx.strokeRect(-10, -ROAD_HALF, 20, ROAD_HEIGHT);
                        
                        // TEKS DI TENGAH
                        ctx.fillStyle = 'white'; ctx.font = 'bold 20px Arial'; ctx.shadowBlur=4;
                        ctx.fillText(`RINTANGAN ${g.id}`, 0, 5);
                    }
                    
                    ctx.shadowBlur = 0; // Reset Shadow Global
                    ctx.restore();
                }
            });

            // Player
            const p = state.player;
            ctx.fillStyle = 'rgba(0,0,0,0.2)';
            // Bayangan ikut Y pemain
            ctx.beginPath(); ctx.ellipse(p.x, p.y + 15, 20, 8, 0, 0, Math.PI*2); ctx.fill();
            // Draw player (p.y is now Absolute, pass jumpOffset)
            drawToonCharacter(ctx, p.x, p.y + (p.jumpOffset || 0), state.playerType, (p.vx !== 0 || p.vy !== 0 || state.crossingAction));
            ctx.fillStyle = 'black'; ctx.font = 'bold 14px Fredoka'; ctx.textAlign = 'center'; 
            ctx.fillText(state.playerName, p.x, p.y - 45 + (p.jumpOffset || 0));

            ctx.restore();
        }

        // Modified DrawObject to accept explicit Y
        function drawObject(obj, overrideY) {
            const y = overrideY !== undefined ? overrideY : obj.y;
            
            // CEK 1: APAKAH ADA GAMBAR KUSTOM UNTUK OBJEK INI?
            if (loadedImages[obj.type]) {
                const img = loadedImages[obj.type];
                
                // Tentukan ukuran gambar (proporsional)
                // Jika objek punya width/height sendiri (seperti building), pakai itu.
                // Jika tidak (seperti tree), kita set default size.
                let drawW = obj.w || 60;
                let drawH = obj.h || 60;

                // Jaga aspek rasio gambar asli agar tidak gepeng
                if (img.width && img.height) {
                    const aspect = img.width / img.height;
                    // Sesuaikan tinggi berdasarkan lebar yang diinginkan
                    drawH = drawW / aspect;
                }

                // Gambar di canvas (Pusat di tengah bawah agar pas di tanah)
                ctx.drawImage(img, obj.x - drawW/2, y - drawH/2, drawW, drawH);
                
                // Return agar tidak menggambar bentuk default (kotak/bulat) di bawahnya
                return;
            }

            // --- JIKA TIDAK ADA GAMBAR, GAMBAR BENTUK DEFAULT (KODE LAMA) ---
            if (obj.type === 'building') {
                ctx.fillStyle = obj.color;
                ctx.fillRect(obj.x - obj.w/2, y - obj.h/2, obj.w, obj.h);
                ctx.lineWidth = 3; ctx.strokeStyle = 'black'; ctx.strokeRect(obj.x - obj.w/2, y - obj.h/2, obj.w, obj.h);
                ctx.fillStyle = 'rgba(255,255,255,0.2)'; ctx.fillRect(obj.x - obj.w/2, y - obj.h/2, obj.w, 10);
                ctx.fillStyle = '#bae6fd';
                for(let iy = y - obj.h/2 + 20; iy < y + obj.h/2 - 20; iy += 25) {
                    for(let ix = obj.x - obj.w/2 + 10; ix < obj.x + obj.w/2 - 10; ix += 25) {
                        ctx.fillRect(ix, iy, 15, 15); ctx.strokeRect(ix, iy, 15, 15);
                    }
                }
            } else if (obj.type === 'tree') {
                ctx.fillStyle = '#16a34a'; ctx.beginPath(); ctx.arc(obj.x, y, 25, 0, Math.PI*2); ctx.fill(); ctx.stroke();
                ctx.fillStyle = '#4ade80'; ctx.beginPath(); ctx.arc(obj.x - 8, y - 8, 8, 0, Math.PI*2); ctx.fill();
            } else if (obj.type === 'car') {
                ctx.save(); ctx.translate(obj.x, y);
                ctx.fillStyle = obj.color; ctx.fillRect(-25, -20, 50, 20); ctx.strokeStyle = 'black'; ctx.strokeRect(-25, -20, 50, 20);
                ctx.fillStyle = 'rgba(150, 200, 255, 0.7)'; ctx.fillRect(-15, -30, 30, 10); ctx.strokeRect(-15, -30, 30, 10);
                ctx.fillStyle = '#1f2937'; ctx.beginPath(); ctx.arc(-15, 0, 5, 0, Math.PI*2); ctx.fill(); ctx.beginPath(); ctx.arc(15, 0, 5, 0, Math.PI*2); ctx.fill();
                if (obj.carType === 'taxi') {
                    ctx.fillStyle = 'black'; ctx.font = 'bold 8px Arial'; ctx.textAlign = 'center'; ctx.fillText("TAKSI", 0, -32);
                    ctx.fillStyle = '#fde047'; ctx.fillRect(-8, -36, 16, 4); ctx.strokeRect(-8, -36, 16, 4);
                }
                ctx.restore();
            } else if (obj.type === 'person') {
                ctx.save(); ctx.translate(obj.x, y);
                ctx.fillStyle = '#ffdecb'; ctx.strokeStyle = 'black'; ctx.lineWidth = 2; ctx.beginPath(); ctx.arc(0, -30, 8, 0, Math.PI*2); ctx.fill(); ctx.stroke();
                ctx.fillStyle = obj.color; ctx.fillRect(-6, -22, 12, 18); ctx.strokeRect(-6, -22, 12, 18);
                ctx.fillStyle = '#1f2937'; ctx.fillRect(-5, -4, 5, 4); ctx.fillRect(0, -4, 5, 4);
                ctx.restore();
            }
        }

        // --- VTUBER CHARACTER DRAWING ---
        function drawToonCharacter(ctx, x, y, type, isMoving) {
            
            // CEK: APAKAH ADA GAMBAR CUSTOM UNTUK PLAYER?
            // Kuncinya: 'player_neko' atau 'player_star'
            const imgKey = `player_${type}`;
            if (loadedImages[imgKey]) {
                const img = loadedImages[imgKey];
                const size = 80; // Ukuran player
                
                ctx.save();
                ctx.translate(x, y);
                
                // Efek Bobbing (Naik turun saat jalan)
                const bob = isMoving ? Math.sin(Date.now() / 80) * 5 : 0;
                ctx.translate(0, bob);

                // Flip gambar jika jalan ke kiri
                if (state.player.vx < 0) ctx.scale(-1, 1);

                // Bayangan sederhana
                ctx.fillStyle = 'rgba(0,0,0,0.2)';
                ctx.beginPath(); ctx.ellipse(0, size/2 - 5, 20, 8, 0, 0, Math.PI*2); ctx.fill();

                // Gambar Karakter
                ctx.drawImage(img, -size/2, -size/2, size, size);
                
                ctx.restore();
                return; // Keluar agar tidak menggambar karakter default
            }

            // --- JIKA TIDAK ADA GAMBAR, GUNAKAN ANIMASI KODE (DEFAULT) ---
            ctx.save(); ctx.translate(x, y);
            
            // 1. Flip jika bergerak ke kiri
            if (state.player.vx < 0) ctx.scale(-1, 1);
            
            // 2. Bobbing animation (Naik turun saat jalan)
            const bob = isMoving ? Math.sin(Date.now() / 80) * 2 : 0;
            ctx.translate(0, bob);

            // 3. Shadow (Bayangan di tanah)
            ctx.fillStyle = 'rgba(0,0,0,0.2)';
            ctx.beginPath(); ctx.ellipse(0, 18, 12, 6, 0, 0, Math.PI*2); ctx.fill();

            // 4. Walk Cycle (Animasi Kaki)
            const walk = isMoving ? Math.sin(Date.now() / 100) * 6 : 0;

            if (type === 'neko') {
                // --- NEKO CHAN (Cat Girl) ---
                
                // Kaki (Stoking Hitam)
                ctx.fillStyle = '#1f2937'; 
                ctx.beginPath(); ctx.ellipse(-6 + walk, 12, 4, 6, 0, 0, Math.PI*2); ctx.fill(); 
                ctx.beginPath(); ctx.ellipse(6 - walk, 12, 4, 6, 0, 0, Math.PI*2); ctx.fill();

                // Badan (Dress Pink)
                ctx.fillStyle = '#ec4899'; ctx.strokeStyle = 'black'; ctx.lineWidth = 2;
                ctx.beginPath(); 
                ctx.moveTo(-10, 10); ctx.lineTo(10, 10); ctx.lineTo(8, -5); ctx.lineTo(-8, -5); ctx.closePath();
                ctx.fill(); ctx.stroke();
                
                // Pita di dada
                ctx.fillStyle = '#fce7f3'; ctx.beginPath(); ctx.arc(0, 0, 3, 0, Math.PI*2); ctx.fill();

                // Kepala (Kulit)
                ctx.fillStyle = '#fef3c7'; 
                ctx.beginPath(); ctx.arc(0, -12, 14, 0, Math.PI*2); ctx.fill(); ctx.stroke();

                // Rambut (Pink Terang)
                ctx.fillStyle = '#db2777'; 
                ctx.beginPath(); 
                ctx.arc(0, -14, 15, Math.PI, 0); // Atas
                ctx.lineTo(16, -5); // Samping Kanan
                ctx.lineTo(10, -12);
                ctx.lineTo(-10, -12);
                ctx.lineTo(-16, -5); // Samping Kiri
                ctx.lineTo(-15, -14);
                ctx.fill(); ctx.stroke();

                // Telinga Kucing (Nekomimi)
                ctx.fillStyle = '#db2777';
                ctx.beginPath(); ctx.moveTo(-10, -25); ctx.lineTo(-18, -35); ctx.lineTo(-2, -28); ctx.fill(); ctx.stroke(); // Kiri
                ctx.beginPath(); ctx.moveTo(10, -25); ctx.lineTo(18, -35); ctx.lineTo(2, -28); ctx.fill(); ctx.stroke(); // Kanan

                // Headphone
                ctx.fillStyle = '#1f2937'; 
                ctx.fillRect(-16, -18, 4, 10); ctx.fillRect(12, -18, 4, 10); // Earcup
                ctx.beginPath(); ctx.arc(0, -20, 14, Math.PI, 0); ctx.stroke(); // Band

                // Wajah
                ctx.fillStyle = 'black'; 
                // Mata Besar
                ctx.beginPath(); ctx.ellipse(-5, -10, 3, 4, 0, 0, Math.PI*2); ctx.fill();
                ctx.beginPath(); ctx.ellipse(5, -10, 3, 4, 0, 0, Math.PI*2); ctx.fill();
                // Kilau Mata
                ctx.fillStyle = 'white';
                ctx.beginPath(); ctx.arc(-4, -12, 1.5, 0, Math.PI*2); ctx.fill();
                ctx.beginPath(); ctx.arc(6, -12, 1.5, 0, Math.PI*2); ctx.fill();
                // Mulut Kucing :3
                ctx.strokeStyle = 'black'; ctx.lineWidth = 1;
                ctx.beginPath(); ctx.moveTo(-2, -6); ctx.quadraticCurveTo(0, -4, 2, -6); ctx.stroke();

            } else {
                // --- HOSHI KUN (Star Boy) ---
                
                // Kaki (Celana Biru)
                ctx.fillStyle = '#0f172a'; 
                ctx.beginPath(); ctx.ellipse(-6 + walk, 12, 4, 6, 0, 0, Math.PI*2); ctx.fill(); 
                ctx.beginPath(); ctx.ellipse(6 - walk, 12, 4, 6, 0, 0, Math.PI*2); ctx.fill();

                // Badan (Hoodie Biru Langit)
                ctx.fillStyle = '#0ea5e9'; ctx.strokeStyle = 'black'; ctx.lineWidth = 2;
                ctx.beginPath(); ctx.roundRect(-10, -5, 20, 16, 4); ctx.fill(); ctx.stroke();
                // Bintang di baju
                ctx.fillStyle = '#facc15';
                ctx.beginPath(); ctx.moveTo(0, 0); ctx.lineTo(2, 5); ctx.lineTo(7, 5); ctx.lineTo(3, 8); ctx.lineTo(5, 13); ctx.lineTo(0, 10); ctx.lineTo(-5, 13); ctx.lineTo(-3, 8); ctx.lineTo(-7, 5); ctx.lineTo(-2, 5); ctx.closePath(); ctx.fill();

                // Kepala
                ctx.fillStyle = '#ffdecb'; 
                ctx.beginPath(); ctx.arc(0, -12, 14, 0, Math.PI*2); ctx.fill(); ctx.stroke();

                // Rambut (Biru Spiky)
                ctx.fillStyle = '#0284c7';
                ctx.beginPath();
                ctx.moveTo(-14, -10);
                ctx.lineTo(-16, -20); // Spike 1
                ctx.lineTo(-8, -18);
                ctx.lineTo(0, -28); // Spike Atas (Ahoge)
                ctx.lineTo(8, -18);
                ctx.lineTo(16, -20); // Spike 2
                ctx.lineTo(14, -10);
                ctx.quadraticCurveTo(0, -15, -14, -10); // Poni
                ctx.fill(); ctx.stroke();

                // Headset Mic
                ctx.strokeStyle = '#38bdf8'; ctx.lineWidth = 1;
                ctx.beginPath(); ctx.moveTo(12, -12); ctx.lineTo(4, -6); ctx.stroke();
                ctx.fillStyle = '#38bdf8'; ctx.beginPath(); ctx.arc(4, -6, 1.5, 0, Math.PI*2); ctx.fill();

                // Wajah Cool
                ctx.fillStyle = 'black';
                ctx.beginPath(); ctx.rect(-7, -12, 4, 2); ctx.fill(); // Mata Kiri Datar
                ctx.beginPath(); ctx.rect(3, -12, 4, 2); ctx.fill();  // Mata Kanan Datar
                ctx.strokeStyle = 'black'; ctx.lineWidth = 1;
                ctx.beginPath(); ctx.moveTo(-2, -5); ctx.lineTo(2, -5); ctx.stroke(); // Mulut Senyum Tipis
            }

            ctx.restore();
        }

        function generateLevel() {
            state.worldObjects = []; state.triggers = []; state.gates = [];
            const prevCp = state.currentLevel === 1 ? null : state.checkpoints[state.currentLevel - 2];
            const startX = prevCp ? prevCp.x : 0;
            state.player.y = getRoadCurve(startX); // Set initial Y to road curve
            state.player.x = startX;
            state.startLineX = startX + 150; state.camera.x = startX - 200;

            for (let x = -200; x < 11000; x += 100) {
                // Objek dekorasi
                // Note: y disimpan sebagai offset dari tengah jalan (Relative Y)
                if (Math.random() < 0.4) state.worldObjects.push({ type: 'building', x: x, y: -ROAD_HALF - 60, w: 60+Math.random()*40, h: 60+Math.random()*60, color: ['#ef4444', '#3b82f6', '#f59e0b', '#a855f7'][Math.floor(Math.random()*4)] });
                if (Math.random() < 0.4) state.worldObjects.push({ type: 'building', x: x, y: ROAD_HALF + 60, w: 60+Math.random()*40, h: 60+Math.random()*60, color: ['#ef4444', '#3b82f6', '#f59e0b', '#a855f7'][Math.floor(Math.random()*4)] });
                if (Math.random() < 0.2) state.worldObjects.push({ type: 'tree', x: x, y: (Math.random()<0.5?-1:1)*(ROAD_HALF + 25) });
                
                // --- MENGHAPUS MOBIL DEKORASI AGAR JALAN SEPI ---
                // Baris kode mobil dihapus sesuai permintaan
                
                if (Math.random() < 0.15) state.worldObjects.push({ type: 'person', x: x - 40 + Math.random()*80, y: (Math.random()<0.5?-1:1)*(ROAD_HALF + 10), color: ['#6366f1', '#e879f9', '#fef08a'][Math.floor(Math.random()*3)] });
            }

            state.checkpoints.forEach(cp => {
                if (cp.type !== 'finish') {
                    state.gates.push({ id: cp.id, x: cp.x, open: false, visual: cp.visual || 'gate' });
                }
                else state.triggers.push({ id: cp.id, x: cp.x, y: 0, radius: 60, active: true });
            });
        }

        // --- UI LOGIC ---
        function initControls() {
            window.addEventListener('keydown', e => { if(['w','ArrowUp'].includes(e.key)) keys.w=true; if(['s','ArrowDown'].includes(e.key)) keys.s=true; if(['a','ArrowLeft'].includes(e.key)) keys.a=true; if(['d','ArrowRight'].includes(e.key)) keys.d=true; });
            window.addEventListener('keyup', e => { if(['w','ArrowUp'].includes(e.key)) keys.w=false; if(['s','ArrowDown'].includes(e.key)) keys.s=false; if(['a','ArrowLeft'].includes(e.key)) keys.a=false; if(['d','ArrowRight'].includes(e.key)) keys.d=false; });
            const setupTouch = (id, k) => { const el = document.getElementById(id); if(el) { el.addEventListener('touchstart',e=>{e.preventDefault();keys[k]=true}); el.addEventListener('touchend',e=>{e.preventDefault();keys[k]=false}); }};
            setupTouch('dpad-up','w'); setupTouch('dpad-down','s'); setupTouch('dpad-left','a'); setupTouch('dpad-right','d');
        }
        
        function initUI() {
            document.getElementById('name-input').addEventListener('input', e => {
                const valid = e.target.value.trim().length > 0;
                document.getElementById('btn-start').disabled = !valid;
                if(valid) document.getElementById('btn-start').classList.remove('opacity-50', 'cursor-not-allowed');
                else document.getElementById('btn-start').classList.add('opacity-50', 'cursor-not-allowed');
            });
        }

        function showScreen(id) {
            ['screen-home', 'screen-map', 'screen-char', 'screen-video', 'screen-quiz', 'screen-gameover', 'screen-finish-message', 'screen-nextlevel', 'screen-rules'].forEach(s => {
                const el = document.getElementById(s); if(el) el.classList.add('hidden');
            });
            if (id !== 'none') document.getElementById(id).classList.remove('hidden');
            
            // Kontrol BGM berdasarkan layar
            if (id === 'none') {
                // MASUK GAMEPLAY
                document.getElementById('hud').classList.remove('hidden');
                document.getElementById('dpad').classList.remove('hidden');
                
                // Pastikan musik menyala saat masuk game
                toggleBGM(true); 
            } else {
                // MENU / INTERFACE LAINNYA
                document.getElementById('hud').classList.add('hidden');
                document.getElementById('dpad').classList.add('hidden');
                
                // PERUBAHAN DI SINI:
                // Matikan musik di SEMUA layar menu (Home, Map, Char Select, dll)
                // Musik hanya akan nyala saat id === 'none' (Gameplay)
                toggleBGM(false);
            }
        }

        // --- GLOBAL FUNCTIONS (For HTML access) ---
        window.goToCharSelect = async () => {
            // PENTING: Ini adalah interaksi pertama user (Klik tombol Start di Menu)
            // Browser mengizinkan audio menyala HANYA setelah interaksi ini.
            try {
                await Tone.start(); 
                console.log("Audio Context Started");
            } catch (e) {
                console.error("Audio Start Failed:", e);
            }

            state.playerName = document.getElementById('name-input').value.trim() || "Noob";
            document.getElementById('player-name-display').innerText = state.playerName;
            savePlayerData();
            showScreen('screen-char');
        };

        window.selectChar = (type) => {
            state.playerType = type;
            const nekoSVG = `<svg viewBox="0 0 100 100" class="w-full h-full"><circle cx="50" cy="50" r="35" fill="#fce7f3" stroke="black"/><path d="M20,30 L30,10 L50,30 Z" fill="#ec4899" stroke="black"/><path d="M80,30 L70,10 L50,30 Z" fill="#ec4899" stroke="black"/><circle cx="35" cy="55" r="4" fill="#be185d"/><circle cx="65" cy="55" r="4" fill="#be185d"/><path d="M45,65 Q50,70 55,65" fill="none" stroke="black" stroke-width="2"/></svg>`;
            const starSVG = `<svg viewBox="0 0 100 100" class="w-full h-full"><circle cx="50" cy="50" r="35" fill="#e0f2fe" stroke="black"/><path d="M20,25 L30,40 L10,40 Z" fill="#facc15" stroke="black" transform="rotate(-30 20 25)"/><path d="M20,40 L30,10 L50,35 L70,10 L80,40" fill="none" stroke="#0ea5e9" stroke-width="4" stroke-linecap="round"/><circle cx="35" cy="55" r="4" fill="#0284c7"/><circle cx="65" cy="55" r="4" fill="#0284c7"/><path d="M45,65 Q50,70 55,65" fill="none" stroke="black" stroke-width="2"/></svg>`;
            
            document.getElementById('avatar-icon').innerHTML = (type === 'neko') ? nekoSVG : starSVG;
            savePlayerData();
            showScreen('screen-map');
            updateMapUI();
        };

        window.selectLevel = (lvl) => {
            if (lvl <= state.maxLevel) {
                state.currentLevel = lvl;
                showScreen('screen-rules');
            }
        };

        window.startGame = async () => {
             // Backup: Cek lagi audio context (kadang di mobile perlu double check)
             if (Tone.context.state !== 'running') await Tone.start();
             
             state.score = 0; 
             state.correctAnswers = 0; // RESET STATS
             state.wrongAnswers = 0;   // RESET STATS
             state.levelResults = [];  // RESET RESULTS LIST
             state.gameActive = true; state.quizActive = false;
             state.currentCheckpoint = state.checkpoints[state.currentLevel - 1] || state.checkpoints[0];
             generateLevel();
             document.getElementById('score-display').innerText = state.score;
             document.getElementById('objective-text').innerText = state.currentCheckpoint.type === 'finish' ? "FINISH" : `LEVEL ${state.currentLevel}`;
             
             // UI Update
             showScreen('none'); // showScreen('none') di kode asli sudah memanggil toggleBGM(true)
             
             // TAPI, kita panggil eksplisit di sini untuk memastikan Transport jalan
             toggleBGM(true);
        };
        
        window.restartGame = () => window.startGame();
        window.goHome = () => showScreen('screen-home');
        
        // --- Added Missing Function ---
        window.closeNextLevelScreen = () => {
            state.quizActive = false; 
            state.gameActive = true;
            showScreen('none');
            if (state.currentCheckpoint) {
                document.getElementById('objective-text').innerText = state.currentCheckpoint.type === 'finish' ? "FINISH" : `LEVEL ${state.currentLevel}`;
            }
        };
        // ------------------------------

        // --- NEW: startCrossingSequence with PRECISION COORDINATES ---
        window.startCrossingSequence = (visualType, gateX) => {
            state.gameActive = true; 
            state.quizActive = false;
            toggleBGM(true); // Pastikan BGM kembali setelah kuis
            
            // Tentukan titik Start dan End yang PRESISI berdasarkan lebar gambar rintangan
            // GateX adalah titik tengah rintangan
            
            let startOffset = -100;
            let endOffset = 100;
            let duration = 2000;

            if (visualType === 'river') {
                // Sungai lebar 200px (-100 sampai +100)
                startOffset = -130; endOffset = 130; duration = 3000; 
            } else if (visualType === 'spike') {
                // Lubang duri lebar 80px (dipersempit)
                startOffset = -60; endOffset = 60; duration = 1500; // ADJUSTED: Lebih dekat & cepat
            } else if (visualType === 'tree' || visualType === 'wall' || visualType === 'accident') {
                // Pohon/Tembok/Tabrakan relatif tipis
                startOffset = -50; endOffset = 50; duration = 2500;
            } else if (visualType === 'cliff') {
                // Tebing Es tipis tapi tinggi
                startOffset = -40; endOffset = 40; duration = 4000; // Lama memanjat
            } else if (visualType === 'croc') {
                // Kolam Buaya (lebar 120px now)
                startOffset = -60; endOffset = 90; duration = 2000; // Lompat dari tengah (rakit) ke ujung
            } else if (visualType === 'tunnel') {
                // Terowongan
                startOffset = -90; endOffset = 90;
            } else if (visualType === 'mud') {
                // Lumpur
                startOffset = -90; endOffset = 90;
            } else if (visualType === 'slime') {
                // Slime kecil
                startOffset = -50; endOffset = 50;
            } else {
                // Default
                startOffset = -60; endOffset = 60;
            }

            state.crossingAction = {
                type: visualType,
                startX: gateX + startOffset, 
                endX: gateX + endOffset,       
                startTime: Date.now(),
                duration: duration
            };
            
            state.player.x = state.crossingAction.startX;
        }

        window.checkAnswer = () => {
            const cp = state.currentCheckpoint;
            let correct = false;
            let feedbackText = '';
            
            // VAR BARU: Untuk Laporan Rinci
            let userAnswerDisplay = "-";
            let correctAnswerDisplay = "-";

            document.getElementById('quiz-submit-btn').disabled = true;

            if (cp.type === 'mcq') {
                // ... (MCQ Logic Tetap) ...
                const sel = document.querySelector('input[name="qopt"]:checked');
                const correctIndex = cp.options.correct;
                if (sel) {
                    const idx = parseInt(sel.value);
                    userAnswerDisplay = cp.options.mcq[idx];
                    if (idx === correctIndex) correct = true;
                } else { userAnswerDisplay = "Tidak menjawab"; }
                correctAnswerDisplay = cp.options.mcq[correctIndex];
                feedbackText = cp.options.explanation;

            } else if (cp.type === 'text-input') { // NEW: LOGIKA ESAI
                const val = document.getElementById('quiz-text-input').value.trim();
                const lowerVal = val.toLowerCase();
                
                userAnswerDisplay = val || "Kosong";
                correctAnswerDisplay = cp.options.keywords[0] + " (atau sinonimnya)";

                // Cek apakah jawaban mengandung salah satu kata kunci
                if (val.length > 0 && cp.options.keywords.some(k => lowerVal.includes(k))) {
                    correct = true;
                    feedbackText = cp.options.feedback.correct;
                } else {
                    feedbackText = cp.options.feedback.wrong;
                }

            } else if (cp.type === 'slider') {
                const val = parseFloat(document.getElementById('quiz-slider').value);
                
                // Simpan Data Laporan
                userAnswerDisplay = val.toString();
                correctAnswerDisplay = `Antara ${cp.options.correctRange[0]} - ${cp.options.correctRange[1]}`;

                if (val >= cp.options.correctRange[0] && val <= cp.options.correctRange[1]) correct = true;
                feedbackText = cp.options.explanation;

            } else if (cp.type === 'calc' || cp.type === 'video-calc') {
                const val = parseFloat(document.getElementById('quiz-number-input').value);
                const target = cp.options.input.correctValue;
                
                // Simpan Data Laporan
                userAnswerDisplay = isNaN(val) ? "Input Tidak Valid" : val.toString();
                correctAnswerDisplay = target.toString();

                if (!isNaN(val) && Math.abs(val - target) <= (cp.options.input.tolerance || 0)) {
                    correct = true; feedbackText = cp.options.feedback.correct;
                } else {
                    feedbackText = cp.options.feedback.wrong;
                }

            } else if (cp.type === 'calc-multi') {
                let allCorrect = true;
                
                // UPDATE: Cek ID 9 (Karena simulasi pindah ke Level 9)
                if (cp.id === 9) {
                    // AMBIL NILAI DARI SIMULASI
                    const m1 = parseFloat(document.getElementById('col-m1').value);
                    const v1 = parseFloat(document.getElementById('col-v1').value);
                    const m2 = parseFloat(document.getElementById('col-m2').value);
                    const v2 = parseFloat(document.getElementById('col-v2').value);
                    
                    // AMBIL JAWABAN USER
                    const userV1 = parseFloat(document.getElementById('ans-v1').value);
                    const userV2 = parseFloat(document.getElementById('ans-v2').value);
                    
                    // Format Jawaban User untuk Laporan
                    userAnswerDisplay = `v1'=${isNaN(userV1)?'?':userV1}, v2'=${isNaN(userV2)?'?':userV2}`;

                    // HITUNG KUNCI JAWABAN
                    const expectedV1 = ((m1 - m2) * v1 + 2 * m2 * v2) / (m1 + m2);
                    const expectedV2 = ((m2 - m1) * v2 + 2 * m1 * v1) / (m1 + m2);
                    
                    // Format Kunci Jawaban untuk Laporan (tetap direkam, tapi jangan tampilkan ke pemain)
                    correctAnswerDisplay = `v1'=${expectedV1.toFixed(2)}, v2'=${expectedV2.toFixed(2)}`;
                    
                    // Validasi
                    if(isNaN(userV1) || Math.abs(userV1 - expectedV1) > 0.1) allCorrect = false;
                    if(isNaN(userV2) || Math.abs(userV2 - expectedV2) > 0.1) allCorrect = false;
                    
                    if (!allCorrect) {
                        // Jangan tampilkan jawaban numerik secara langsung ke pemain.
                        // Tampilkan petunjuk rumus yang sudah didefinisikan di cp.options.feedback.wrong
                        feedbackText = (cp.options && cp.options.feedback && cp.options.feedback.wrong) ? cp.options.feedback.wrong : "Petunjuk: gunakan rumus tumbukan lenting untuk menghitung v1' dan v2'";
                    }
                }
                if (allCorrect) { correct = true; feedbackText = cp.options.feedback.correct; }
                else { correct = false; feedbackText = feedbackText || cp.options.feedback.wrong; }
            }
            
            // --- NEW: LOG RESULT LENGKAP ---
            const scoreChange = correct ? (10 + Math.floor(Math.max(0, 15 - Math.round((Date.now() - state.quizStartTime)/1000)))) : -5;
            state.levelResults.push({
                level: state.currentLevel,
                question: cp.question,
                isCorrect: correct,
                points: scoreChange,
                userAnswer: userAnswerDisplay,      // REKAM JAWABAN USER
                correctAnswer: correctAnswerDisplay // REKAM KUNCI JAWABAN
            });

            const fb = document.getElementById('quiz-feedback');
            if (correct) {
                state.correctAnswers++; // TRACK CORRECT
                
                // Gunakan variable scoreChange yang sudah dihitung di atas
                fb.innerText = `BENAR! üéâ (${scoreChange > 0 ? '+' : ''}${scoreChange} Poin)`;
                fb.className = "text-center font-black mt-2 h-auto text-green-600 text-sm";
                state.score += scoreChange;
                document.getElementById('score-display').innerText = state.score;
                
                if(synthCorrect) synthCorrect.triggerAttackRelease("C4", "0.2");
                
                const g = state.gates.find(gate => gate.id === cp.id); if(g) g.open = true;
                const t = state.triggers.find(tr => tr.id === cp.id); if(t) t.active = false;
                
                // TRIGGER ANIMATION SEQUENCE (Replaces immediate timeout)
                setTimeout(() => {
                    showScreen('none'); // Hide quiz and restart BGM
                    // PASS gate.x ke fungsi animasi agar tahu harus melompat seberapa jauh
                    startCrossingSequence(cp.visual || 'gate', g ? g.x : state.player.x + 100); 
                    
                    // Update Logic after animation starts
                    state.currentLevel++;
                    if(state.currentLevel > state.maxLevel) { state.maxLevel = state.currentLevel; savePlayerData(); }
                    if(state.currentLevel <= state.checkpoints.length) state.currentCheckpoint = state.checkpoints[state.currentLevel - 1];
                }, 1000); // Short delay to see "BENAR!"

            } else {
                state.wrongAnswers++; // TRACK WRONG
                fb.innerText = `SALAH! üíÄ (-5 Poin)`;
                fb.className = "text-center font-black mt-2 h-auto text-red-600 text-sm";
                if(synthWrong) synthWrong.triggerAttackRelease("F#3", "0.3");
                state.score -= 5;
                document.getElementById('score-display').innerText = state.score;
                setTimeout(() => {
                    document.getElementById('quiz-submit-btn').disabled = false;
                    fb.innerText = `Coba lagi! (Petunjuk: ${feedbackText})`;
                    fb.className = "text-center font-black mt-2 h-auto text-yellow-600 text-sm";
                }, 2000);
            }
        };

        window.proceedToQuestion = () => {
            document.getElementById('level-video').pause();
            prepareQuizUI(state.currentCheckpoint);
        };
        
        // --- HELPERS ---
        function showQuiz(cp) {
            // BGM dihentikan di triggerCheckpoint
            state.quizActive = true; state.currentCheckpoint = cp;
            if (cp.type === 'video-calc') {
                showScreen('screen-video');
                document.getElementById('video-narrative').innerText = cp.narrative;
                const vid = document.getElementById('level-video'); vid.src = cp.videoUrl; vid.load();
                return;
            }
            prepareQuizUI(cp);
        }

        function prepareQuizUI(cp) {
            document.getElementById('quiz-level-num').innerText = state.currentLevel;
            document.getElementById('quiz-question').innerText = cp.question;
            document.getElementById('quiz-feedback').innerText = '';
            document.getElementById('quiz-submit-btn').disabled = false;
            
            // Hide all options first
            ['mcq', 'slider', 'cutscene', 'input', 'multi-input', 'text'].forEach(id => document.getElementById(`quiz-options-${id}`).classList.add('hidden'));
            document.getElementById('quiz-question-container').classList.remove('hidden');

            // UPDATE: Handle Custom Image & Simulation
            if (cp.sim) {
                if (cp.sim.type === 'image') {
                    const box = document.getElementById('quiz-options-cutscene');
                    box.classList.remove('hidden');
                    // Tampilkan gambar dengan styling agar pas di kotak
                    box.innerHTML = `<div class="w-full h-64 flex items-center justify-center bg-gray-200 rounded-lg overflow-hidden border-2 border-black"><img src="${cp.sim.src}" class="max-w-full max-h-full object-contain" alt="Soal Visual"></div>`;
                } else if (cp.sim.type) {
                    setupSimulation(cp.sim.type);
                }
            }

            if (cp.type === 'mcq') {
                const c = document.getElementById('quiz-options-mcq'); c.classList.remove('hidden'); c.innerHTML = '';
                cp.options.mcq.forEach((opt, i) => c.innerHTML += `<label class="block w-full text-left p-2 rounded-lg border-2 border-black bg-white cursor-pointer hover:bg-blue-50 text-sm"><input type="radio" name="qopt" value="${i}" class="mr-2 accent-black"> <span class="font-bold">${opt}</span></label>`);
            } else if (cp.type === 'text-input') { // NEW: TAMPILKAN INPUT TEKS
                document.getElementById('quiz-options-text').classList.remove('hidden');
                document.getElementById('quiz-text-input').value = '';
                document.getElementById('quiz-text-input').focus();
            } else if (cp.type === 'slider') {
                document.getElementById('quiz-options-slider').classList.remove('hidden');
                document.getElementById('slider-label-left').innerText = cp.options.slider.minLabel;
                document.getElementById('slider-label-right').innerText = cp.options.slider.maxLabel;
                const s = document.getElementById('quiz-slider'); s.min = cp.options.slider.min; s.max = cp.options.slider.max; s.value = cp.options.slider.value;
                document.getElementById('slider-value').innerText = s.value; s.oninput = e => document.getElementById('slider-value').innerText = e.target.value;
            } else if (cp.type === 'calc' || cp.type === 'video-calc') {
                document.getElementById('quiz-options-input').classList.remove('hidden');
                document.getElementById('quiz-number-input').value = '';
            } else if (cp.type === 'calc-multi') {
                const c = document.getElementById('quiz-options-multi-input'); c.classList.remove('hidden'); c.innerHTML = '';
                cp.options.inputs.forEach(inp => c.innerHTML += `<div class="mb-2"><label class="block text-[10px] font-black text-gray-700 uppercase mb-1">${inp.label}:</label><div class="flex items-center gap-1"><input type="number" id="${inp.id}" placeholder="?" class="w-full p-1.5 text-lg font-bold text-center border-2 border-black rounded focus:bg-yellow-50 outline-none"><span class="text-xs font-bold text-gray-500">${inp.unit}</span></div></div>`);
            }
            showScreen('screen-quiz');
            state.quizStartTime = Date.now();
        }

        function updateMapUI() {
            document.querySelectorAll('.map-pin').forEach(p => {
                const match = p.getAttribute('onclick').match(/selectLevel\((\d+)\)/);
                if (!match) return;
                const lvl = parseInt(match[1]);
                
                // Reset classes
                p.classList.remove('locked', 'completed', 'current');
                
                let t = (lvl===10)?'üèÅ':lvl; 
                let l = '';
                
                if (lvl < state.maxLevel) { 
                    p.classList.add('completed'); 
                    t='‚úîÔ∏è'; 
                    // l=(lvl===1)?'Start':''; 
                }
                else if (lvl === state.maxLevel) { 
                    // Highlight level yang harus dimainkan sekarang
                    p.classList.add('current'); 
                    l=(lvl===1)?'MULAI!':'Main'; 
                }
                else { 
                    p.classList.add('locked'); 
                    if(lvl!==10){t='üîí';} else{l='Finish';} 
                }
                
                p.innerHTML = `${t}${l?`<span class="map-pin-label">${l}</span>`:''}`;
            });
        }

        function executeFinishSequence() {
             // BGM sudah dihentikan di updatePhysics
             state.score += 50;
             updateLeaderboard(state.score);
             document.getElementById('finish-player-name').innerText = state.playerName;
             document.getElementById('finish-player-score').innerText = state.score;
             
             // --- NEW: KIRIM DATA KE FIREBASE ---
             saveGameResultToFirebase();
             
             // UPDATE STATS DISPLAY
             document.getElementById('finish-correct-count').innerText = state.correctAnswers;
             document.getElementById('finish-wrong-count').innerText = state.wrongAnswers;
             
             // UPDATE DETAIL LIST
             const list = document.getElementById('finish-details-list');
             list.innerHTML = '';
             state.levelResults.forEach(res => {
                 const color = res.isCorrect ? 'text-green-600' : 'text-red-600';
                 const icon = res.isCorrect ? '‚úÖ' : '‚ùå';
                 const points = res.points > 0 ? `+${res.points}` : res.points;
                 // Truncate question for UI
                 const qText = res.question.length > 50 ? res.question.substring(0, 50) + '...' : res.question;
                 
                 list.innerHTML += `
                    <li class="flex justify-between items-start border-b border-gray-100 pb-2">
                        <div class="w-3/4">
                            <span class="font-black text-gray-800">Lvl ${res.level}</span>
                            <p class="text-[10px] text-gray-500 leading-tight">${qText}</p>
                        </div>
                        <div class="${color} font-black text-right">
                            <div>${icon}</div>
                            <div class="text-[10px]">${points} Poin</div>
                        </div>
                    </li>
                 `;
             });

             showScreen('screen-finish-message');
             toggleBGM(false); // Pastikan BGM mati di layar finish
        }

        // --- NEW: FUNGSI DOWNLOAD RAPOR (DIPERBARUI) ---
        window.downloadReport = () => {
            const now = new Date();
            const dateStr = now.toLocaleDateString('id-ID', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
            const timeStr = now.toLocaleTimeString('id-ID');
            
            let content = `=================================================\n`;
            content += `           RAPOR PETUALANGAN FISIKA 2D           \n`;
            content += `=================================================\n\n`;
            content += `Nama Pemain   : ${state.playerName}\n`;
            content += `Karakter      : ${state.playerType === 'neko' ? 'Lucy (Neko)' : 'Luke (Star)'}\n`;
            content += `Waktu Main    : ${dateStr}, ${timeStr}\n`;
            content += `Total Skor    : ${state.score}\n`;
            content += `Jawaban Benar : ${state.correctAnswers}\n`;
            content += `Jawaban Salah : ${state.wrongAnswers}\n\n`;
            
            content += `=================================================\n`;
            content += `                RINCIAN PER LEVEL                \n`;
            content += `=================================================\n\n`;
            
            state.levelResults.forEach((res, index) => {
                const status = res.isCorrect ? "BENAR [‚úî]" : "SALAH [X]";
                
                content += `NO. TANTANGAN : ${res.level}\n`;
                content += `STATUS        : ${status}\n`;
                content += `SOAL          : ${res.question}\n`;
                content += `JAWABAN KAMU  : ${res.userAnswer}\n`;
                content += `KUNCI JAWABAN : ${res.correctAnswer}\n`;
                content += `POIN DIPEROLEH: ${res.points > 0 ? '+' + res.points : res.points}\n`;
                content += `-------------------------------------------------\n`;
            });

            content += `\nCatatan: \n`;
            content += `- Jika jawabanmu salah, bandingkan dengan kunci jawaban untuk belajar.\n`;
            content += `- Fisika itu asik! Teruslah berlatih.\n\n`;
            content += `Physics Adventure 2D - Educational Game`;

            // Membuat Blob dan Link Download
            const blob = new Blob([content], { type: 'text/plain' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.style.display = 'none';
            a.href = url;
            // Nama file: Rapor_Nama_Timestamp.txt
            a.download = `Rapor_Lengkap_${state.playerName.replace(/\s+/g, '_')}.txt`;
            
            document.body.appendChild(a);
            a.click();
            
            // Bersihkan
            window.URL.revokeObjectURL(url);
            document.body.removeChild(a);
        };
        
        // --- NEW FUNCTION: SAVE GAME RESULT TO FIREBASE ---
        async function saveGameResultToFirebase() {
            if (!userId || userId === 'offline' || !db) return;
            
            try {
                // Siapkan data hasil permainan
                const gameResult = {
                    playerName: state.playerName,
                    playerType: state.playerType,
                    userId: userId,
                    score: state.score,
                    correctAnswers: state.correctAnswers,
                    wrongAnswers: state.wrongAnswers,
                    totalLevelsCompleted: state.currentLevel,
                    levelResults: state.levelResults,
                    finishTime: serverTimestamp(),
                    gameVersion: "1.0"
                };

                // Simpan ke collection "game_results"
                await addDoc(collection(db, "game_results"), gameResult);
                
                console.log("‚úÖ Game result saved to Firebase!");
            } catch (error) {
                console.error("‚ùå Error saving game result:", error);
            }
        }
        
        // --- DATABASE ---
        async function savePlayerData() {
            if (!userId || userId==='offline' || !db) return;
            try { await setDoc(doc(db, "artifacts", appId, "users", userId, "playerData", "save"), { name: state.playerName, type: state.playerType, maxLvl: state.maxLevel, ts: serverTimestamp() }, {merge:true}); } catch(e) {}
        }
        async function loadPlayerData() {
            if (!userId || userId==='offline' || !db) return;
            try {
                const snap = await getDoc(doc(db, "artifacts", appId, "users", userId, "playerData", "save"));
                if (snap.exists()) {
                    const d = snap.data();
                    state.playerName = d.name || "Noob"; state.playerType = d.type || "neko"; state.maxLevel = d.maxLvl || 1;
                    document.getElementById('name-input').value = state.playerName;
                    document.getElementById('btn-start').disabled = false;
                    document.getElementById('btn-start').classList.remove('opacity-50', 'cursor-not-allowed');
                }
            } catch(e) {}
        }
        async function updateLeaderboard(score) {
            if (!userId || userId==='offline' || !db) return;
            try { await addDoc(collection(db, "artifacts", appId, "public", "data", "leaderboard"), { name: state.playerName, score: score, userId: userId }); } catch(e){}
        }
        function loadLeaderboard() {
            if (!db) return;
            if (unsubLeaderboard) unsubLeaderboard();
            const q = query(collection(db, "artifacts", appId, "public", "data", "leaderboard"), limit(5));
            unsubLeaderboard = onSnapshot(q, (snap) => {
                const list = document.getElementById('leaderboard-list'); list.innerHTML = '';
                const scores = []; snap.forEach(d => scores.push(d.data()));
                scores.sort((a,b) => b.score - a.score);
                scores.forEach(s => list.innerHTML += `<li class="flex justify-between p-1 border-b border-gray-300"><span>${s.name}</span><span class="font-black">${s.score}</span></li>`);
                if(scores.length===0) list.innerHTML = '<li class="text-center italic text-gray-500">Belum ada data</li>';
            });
        }

        // --- COLLISION SIMULATION (Global for Level 1) ---
        window.initCollisionSim = () => {
            const canvas = document.getElementById('col-canvas'); if(!canvas) return;
            const ctx = canvas.getContext('2d');
            const W = 600, H = 200; canvas.width = W; canvas.height = H;
            const els = { m1: document.getElementById('col-m1'), m2: document.getElementById('col-m2'), v1: document.getElementById('col-v1'), v2: document.getElementById('col-v2'), play: document.getElementById('col-play'), pause: document.getElementById('col-pause'), reset: document.getElementById('col-reset'), v1Disp: document.getElementById('col-v1-disp'), v2Disp: document.getElementById('col-v2-disp') };
            let running = false, lastTimestamp = null;
            let s = { m1: parseFloat(els.m1.value), m2: parseFloat(els.m2.value), v1: parseFloat(els.v1.value), v2: parseFloat(els.v2.value) };
            let x1=100, x2=500, r1, r2;
            let hasCollided = false; // NEW: Flag untuk mencegah tumbukan berulang
            
            function reset() { 
                s.m1=parseFloat(els.m1.value); s.m2=parseFloat(els.m2.value); s.v1=parseFloat(els.v1.value); s.v2=parseFloat(els.v2.value); 
                r1=Math.max(12, Math.sqrt(s.m1)*15); r2=Math.max(12, Math.sqrt(s.m2)*15); 
                x1=100; x2=500; 
                running=false; lastTimestamp=null; 
                hasCollided = false; // Reset flag saat tombol reset ditekan
                updateDisp(); draw(); 
            }
            function updateDisp() { if(els.v1Disp) els.v1Disp.innerText=s.v1.toFixed(2); if(els.v2Disp) els.v2Disp.innerText=s.v2.toFixed(2); }
            function draw() {
                ctx.clearRect(0,0,W,H);
                ctx.fillStyle='#dfeefb'; ctx.fillRect(20, H/2-2, W-40, 4);
                // Gambar Garis Kecepatan
                drawArrow(x1, H/2, s.v1, '#155e75');
                drawArrow(x2, H/2, s.v2, '#be185d');
                
                ctx.beginPath(); ctx.fillStyle='#2fb6c9'; ctx.arc(x1, H/2, r1, 0, Math.PI*2); ctx.fill(); ctx.fillStyle='white'; ctx.fillText('1', x1-3, H/2+3);
                ctx.beginPath(); ctx.fillStyle='#ff66b2'; ctx.arc(x2, H/2, r2, 0, Math.PI*2); ctx.fill(); ctx.fillStyle='white'; ctx.fillText('2', x2-3, H/2+3);
            }
            function drawArrow(x, y, v, color) {
                if(Math.abs(v) < 0.1) return;
                const len = v * 20; 
                ctx.beginPath(); ctx.strokeStyle = color; ctx.lineWidth = 2;
                ctx.moveTo(x, y - 30); ctx.lineTo(x + len, y - 30); ctx.stroke();
                ctx.beginPath(); ctx.fillStyle = color;
                if (v > 0) { ctx.moveTo(x+len, y-35); ctx.lineTo(x+len+5, y-30); ctx.lineTo(x+len, y-25); }
                else { ctx.moveTo(x+len, y-35); ctx.lineTo(x+len-5, y-30); ctx.lineTo(x+len, y-25); }
                ctx.fill();
            }
            function loop(ts) {
                if(!document.getElementById('col-canvas')) return;
                if(!running) { lastTimestamp=null; return; }
                if(!lastTimestamp) lastTimestamp=ts;
                const dt = Math.min(0.03, (ts-lastTimestamp)/1000); lastTimestamp=ts;
                
                // Update Posisi
                x1 += s.v1 * 100 * dt; 
                x2 += s.v2 * 100 * dt;
                
                // Cek Tabrakan (Hanya jika belum pernah bertumbukan)
                if(!hasCollided && x2 - x1 <= r1 + r2) {
                      const u1=s.v1, u2=s.v2, m1=s.m1, m2=s.m2;
                      
                      // Rumus Tumbukan Lenting Sempurna
                      const v1Final = ((m1 - m2) * u1 + 2 * m2 * u2) / (m1 + m2);
                      const v2Final = ((m2 - m1) * u2 + 2 * m1 * u1) / (m1 + m2);
                      
                      s.v1 = v1Final;
                      s.v2 = v2Final;

                      // KOREKSI POSISI AGAR TIDAK NEMPEL (OVERLAP)
                      const overlap = (r1 + r2) - (x2 - x1);
                      x1 -= overlap / 2 + 1; 
                      x2 += overlap / 2 + 1; 
                      
                      hasCollided = true; // Tandai tumbukan sudah terjadi
                      updateDisp();
                }

                // Hentikan simulasi jika bola keluar layar (agar tidak memantul balik)
                if(x1 + r1 < 0 || x2 - r2 > W) {
                    running = false;
                }
                
                draw(); requestAnimationFrame(loop);
            }
            els.play.onclick=()=>{if(!running){running=true;requestAnimationFrame(loop);}}; els.pause.onclick=()=>{running=false;}; els.reset.onclick=reset;
            [els.m1,els.m2,els.v1,els.v2].forEach(e=>e.onchange=()=>{if(!running)reset()});
            reset();
        };

        function setupSimulation(type) {
            const box = document.getElementById('quiz-options-cutscene');
            box.classList.remove('hidden');
            if (type === 'q1-momentum-interactive') {
                box.innerHTML = `<div class="sim-stage"><canvas id="col-canvas"></canvas><div class="flex flex-col gap-2 text-xs font-bold"><div class="sim-row"><label class="text-blue-600">Benda 1: Massa <input id="col-m1" type="number" step="0.1" value="0.5">kg, Vel <input id="col-v1" type="number" step="0.1" value="1.0">m/s</label></div><div class="sim-row"><label class="text-pink-600">Benda 2: Massa <input id="col-m2" type="number" step="0.1" value="1.5">kg, Vel <input id="col-v2" type="number" step="0.1" value="-0.5">m/s</label></div><div class="sim-flex"><button id="col-play" class="sim-btn">Play</button><button id="col-pause" class="sim-btn secondary">Pause</button><button id="col-reset" class="sim-btn secondary">Reset</button></div><div class="mt-2 p-1 bg-gray-50 border text-[9px]">v1=<span id="col-v1-disp">1.00</span>, v2=<span id="col-v2-disp">-0.50</span></div></div></div>`;
                setTimeout(() => window.initCollisionSim(), 50);
            }
        }
    </script>
</body>
</html>